<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zulu Club ‚Äì AI Gallery Curator</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            padding: 20px;
            color: #1e293b;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { font-size: 2rem; margin-bottom: 0.5rem; color: #0f172a; }
        .subtitle {
            color: #475569;
            margin-bottom: 2rem;
            border-left: 4px solid #3b82f6;
            padding-left: 1rem;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            padding: 24px;
            margin-bottom: 24px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .form-group { margin-bottom: 16px; }
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: #334155;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.2s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            ring: 2px solid #bfdbfe;
        }
        textarea {
            min-height: 120px;
            font-family: 'Courier New', monospace;
        }
        .help-text {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 16px;
        }
        button:hover { background: #2563eb; }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error {
            background: #fee2e2;
            color: #b91c1c;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
        }
        .stats {
            background: #e0f2fe;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            font-weight: 500;
        }
        /* Table editor styles */
        .editor-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        .editor-table th {
            text-align: left;
            padding: 12px 8px;
            background: #f1f5f9;
            font-weight: 600;
        }
        .editor-table td {
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
        }
        .editor-table input, .editor-table textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
        }
        .editor-table textarea {
            min-height: 60px;
            resize: vertical;
        }
        /* Download options */
        .download-options {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            flex-wrap: wrap;
            margin: 16px 0;
        }
        .download-options > div {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .download-options select {
            width: auto;
            min-width: 150px;
        }
        .download-btn {
            background: #059669;
            padding: 8px 16px;
            font-size: 14px;
        }
        .download-btn:hover { background: #047857; }
        .gallery {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .gallery-header {
            background: #f8fafc;
            padding: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
        }
        .gallery-header h3 { font-size: 1.2rem; color: #0f172a; }
        .gallery-description { color: #475569; margin-top: 4px; }
        .gallery-tags {
            font-size: 0.85rem;
            color: #2563eb;
            margin-top: 4px;
        }
        .gallery-products {
            padding: 16px;
            background: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            text-align: left;
            padding: 8px;
            background: #f1f5f9;
            font-weight: 600;
        }
        td {
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
        }
        .score-badge {
            background: #dcfce7;
            color: #166534;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        .copy-btn {
            background: #475569;
        }
        .copy-btn:hover { background: #1e293b; }
        .flex {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }
        .json-output {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow: auto;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .top-btn {
            background: #8b5cf6;
            font-size: 1rem;
            padding: 10px 20px;
        }
        .top-btn:hover { background: #7c3aed; }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <h1>üé® AI Gallery Curator</h1>
            <button id="downloadComboBtn" class="top-btn">üìä Download Combo CSV</button>
        </div>
        <div class="subtitle">
            Step 1: Generate gallery themes ‚Äì Step 2: Review & edit ‚Äì Step 3: Curate products
        </div>

        <!-- Step 1: Input form -->
        <div class="card" id="step1">
            <form id="generateForm">
                <div class="form-grid">
                    <div>
                        <div class="form-group">
                            <label for="productIds">Product IDs (one per line, or comma‚Äëseparated)</label>
                            <textarea id="productIds" placeholder="e.g. 101, 102, 103&#10;201, 202" required></textarea>
                            <div class="help-text">Up to 5000 IDs allowed.</div>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="userPrompt">User Prompt / Instructions</label>
                            <textarea id="userPrompt" placeholder="e.g. Create 3 galleries: one for affordable home decor under ‚Çπ1000, one for premium lighting, and one for trendy fashion accessories." required></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="numGalleries">Number of Galleries</label>
                        <input type="number" id="numGalleries" min="1" max="20" value="5">
                    </div>
                    <div class="form-group">
                        <label for="minProducts">Minimum Products per Gallery</label>
                        <input type="number" id="minProducts" min="1" max="50" value="3">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="maxProducts">Maximum Products per Gallery</label>
                        <input type="number" id="maxProducts" min="1" max="200" value="20">
                    </div>
                    <div class="form-group">
                        <label for="threshold">Relevance Threshold (0‚Äë1)</label>
                        <input type="number" id="threshold" min="0" max="1" step="0.05" value="0.6">
                    </div>
                </div>

                <div class="flex" style="justify-content: space-between; margin-top: 20px;">
                    <button type="submit" id="generateBtn">
                        <span id="genBtnText">‚ú® Generate Gallery Themes</span>
                        <span id="genLoadingSpinner" class="loading" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>

        <div id="errorMessage" class="error" style="display: none;"></div>

        <!-- Step 2: Editable galleries (TABLE format) -->
        <div id="step2" style="display: none;">
            <div class="card">
                <h2>üìù Review & Edit Galleries</h2>
                <p>Edit gallery names, descriptions, and tags (comma‚Äëseparated).</p>
                <table class="editor-table" id="galleryEditorTable">
                    <thead>
                        <tr>
                            <th>Gallery Name</th>
                            <th>Description</th>
                            <th>Tags (comma separated)</th>
                        </tr>
                    </thead>
                    <tbody id="editorTableBody">
                        <!-- rows will be inserted here -->
                    </tbody>
                </table>
                <div class="flex" style="justify-content: flex-end; margin-top: 20px;">
                    <button id="backToStep1Btn" style="background: #64748b; margin-right: auto;">‚Üê Back</button>
                    <button id="curateBtn">‚úÖ Confirm & Curate Products</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Results -->
        <div id="step3" style="display: none;">
            <div class="card">
                <div class="flex" style="justify-content: space-between;">
                    <h2>Curated Galleries</h2>
                    <button class="copy-btn" id="copyJsonBtn">üìã Copy Full JSON</button>
                </div>

                <!-- Download options with two separate select + button pairs -->
                <div class="download-options">
                    <div>
                        <label for="csvFormatSelect">CSV Format:</label>
                        <select id="csvFormatSelect">
                            <option value="full">Full details</option>
                            <option value="ids">IDs only</option>
                            <option value="idsCount">IDs + count</option>
                            <option value="count">Count only</option>
                        </select>
                        <button id="downloadCsvBtn" class="download-btn">üì• Download CSV</button>
                    </div>
                    <div>
                        <label for="jsonFormatSelect">JSON Format:</label>
                        <select id="jsonFormatSelect">
                            <option value="full">Full details</option>
                            <option value="ids">IDs only</option>
                            <option value="idsCount">IDs + count</option>
                            <option value="count">Count only</option>
                        </select>
                        <button id="downloadJsonBtn" class="download-btn">üì• Download JSON</button>
                    </div>
                </div>

                <div id="statsMessage" class="stats" style="display: none;"></div>
                <div id="galleriesContainer"></div>
                <div class="json-output" id="rawJson" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        // DOM elements
        const generateForm = document.getElementById('generateForm');
        const generateBtn = document.getElementById('generateBtn');
        const genBtnText = document.getElementById('genBtnText');
        const genLoading = document.getElementById('genLoadingSpinner');
        const errorDiv = document.getElementById('errorMessage');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const editorTableBody = document.getElementById('editorTableBody');
        const backBtn = document.getElementById('backToStep1Btn');
        const curateBtn = document.getElementById('curateBtn');
        const statsDiv = document.getElementById('statsMessage');
        const galleriesContainer = document.getElementById('galleriesContainer');
        const rawJsonPre = document.getElementById('rawJson');
        const copyJsonBtn = document.getElementById('copyJsonBtn');
        const downloadComboBtn = document.getElementById('downloadComboBtn');
        const csvFormatSelect = document.getElementById('csvFormatSelect');
        const jsonFormatSelect = document.getElementById('jsonFormatSelect');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        const downloadJsonBtn = document.getElementById('downloadJsonBtn');

        // State
        let currentProductIds = [];
        let currentUserPrompt = '';
        let currentMin = 3;
        let currentMax = 20;
        let currentThreshold = 0.6;
        let generatedGalleries = [];
        let curatedResult = null; // store result from curation

        // Parse product IDs from textarea
        function parseProductIds(input) {
            const cleaned = input.replace(/,/g, ' ').split(/\s+/).filter(id => id.trim() !== '');
            return cleaned.map(id => parseInt(id, 10)).filter(id => !isNaN(id) && id > 0);
        }

        // Toggle loading for generate button
        function setGenerateLoading(isLoading) {
            generateBtn.disabled = isLoading;
            if (isLoading) {
                genBtnText.style.display = 'none';
                genLoading.style.display = 'inline-block';
            } else {
                genBtnText.style.display = 'inline';
                genLoading.style.display = 'none';
            }
        }

        function showError(message) {
            errorDiv.style.display = 'block';
            errorDiv.textContent = message;
        }
        function hideError() { errorDiv.style.display = 'none'; }

        // Escape HTML to prevent injection
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Render editable galleries as a table
        function renderEditableGalleries(galleries) {
            editorTableBody.innerHTML = '';
            galleries.forEach((gallery, idx) => {
                const row = document.createElement('tr');
                // Name cell
                const nameCell = document.createElement('td');
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'gallery-name-input';
                nameInput.value = gallery.name || '';
                nameCell.appendChild(nameInput);
                // Description cell
                const descCell = document.createElement('td');
                const descInput = document.createElement('textarea');
                descInput.className = 'gallery-desc-input';
                descInput.rows = 2;
                descInput.value = gallery.description || '';
                descCell.appendChild(descInput);
                // Tags cell (comma-separated)
                const tagsCell = document.createElement('td');
                const tagsInput = document.createElement('input');
                tagsInput.type = 'text';
                tagsInput.className = 'gallery-tags-input';
                tagsInput.value = (gallery.tags || []).join(', ');
                tagsCell.appendChild(tagsInput);
                // Append all
                row.appendChild(nameCell);
                row.appendChild(descCell);
                row.appendChild(tagsCell);
                editorTableBody.appendChild(row);
            });
        }

        // Collect current gallery data from table
        function collectGalleriesFromTable() {
            const galleries = [];
            const rows = editorTableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const nameInput = row.querySelector('.gallery-name-input');
                const descInput = row.querySelector('.gallery-desc-input');
                const tagsInput = row.querySelector('.gallery-tags-input');
                const name = nameInput ? nameInput.value.trim() : '';
                const description = descInput ? descInput.value.trim() : '';
                const tagsString = tagsInput ? tagsInput.value.trim() : '';
                const tags = tagsString.split(',').map(t => t.trim()).filter(t => t !== '');
                if (name) {
                    galleries.push({ name, description, tags });
                }
            });
            return galleries;
        }

        // Handle generate form submit
        generateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();

            const productIdsRaw = document.getElementById('productIds').value.trim();
            const userPrompt = document.getElementById('userPrompt').value.trim();
            const numGalleries = parseInt(document.getElementById('numGalleries').value, 10);
            const minProducts = parseInt(document.getElementById('minProducts').value, 10);
            const maxProducts = parseInt(document.getElementById('maxProducts').value, 10);
            const threshold = parseFloat(document.getElementById('threshold').value);

            if (!productIdsRaw) { showError('Please enter product IDs.'); return; }
            if (!userPrompt) { showError('Please enter a user prompt.'); return; }

            const productIds = parseProductIds(productIdsRaw);
            if (productIds.length === 0) { showError('No valid product IDs.'); return; }
            if (productIds.length > 5000) { showError('Max 5000 IDs.'); return; }

            // Store for later steps
            currentProductIds = productIds;
            currentUserPrompt = userPrompt;
            currentMin = minProducts;
            currentMax = maxProducts;
            currentThreshold = threshold;

            setGenerateLoading(true);

            try {
                const response = await fetch('/api/ai/generate-galleries2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userPrompt,
                        numGalleries,
                        sampleProductIds: productIds.slice(0, 20)
                    })
                });

                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Generation failed');
                }

                generatedGalleries = result.data.galleries;
                renderEditableGalleries(generatedGalleries);
                step1.style.display = 'none';
                step2.style.display = 'block';
                step3.style.display = 'none';
            } catch (err) {
                showError(`Error: ${err.message}`);
            } finally {
                setGenerateLoading(false);
            }
        });

        // Back button
        backBtn.addEventListener('click', () => {
            step1.style.display = 'block';
            step2.style.display = 'none';
            step3.style.display = 'none';
        });

        // Curate button
        curateBtn.addEventListener('click', async () => {
            const finalGalleries = collectGalleriesFromTable();
            if (finalGalleries.length === 0) {
                showError('At least one gallery is required.');
                return;
            }

            curateBtn.disabled = true;
            curateBtn.textContent = 'Curating...';

            try {
                const response = await fetch('/api/ai/curate-galleries', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productIds: currentProductIds,
                        galleries: finalGalleries,
                        minProductsPerGallery: currentMin,
                        maxProductsPerGallery: currentMax,
                        threshold: currentThreshold,
                        batchSize: 50
                    })
                });

                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Curation failed');
                }

                curatedResult = result.data; // store for later downloads

                if (result.stats) {
                    statsDiv.style.display = 'block';
                    statsDiv.innerHTML = `
                        <strong>üìä Statistics</strong><br>
                        Total products provided: ${result.stats.totalProductsProvided}<br>
                        Products assigned: ${result.stats.productsAssigned}<br>
                        Unassigned: ${result.stats.unassigned}
                    `;
                }

                renderFinalGalleries(result.data);
                rawJsonPre.textContent = JSON.stringify(result.data, null, 2);
                step2.style.display = 'none';
                step3.style.display = 'block';
            } catch (err) {
                showError(`Error: ${err.message}`);
            } finally {
                curateBtn.disabled = false;
                curateBtn.textContent = '‚úÖ Confirm & Curate Products';
            }
        });

        // Render final galleries (collapsible)
        function renderFinalGalleries(data) {
            galleriesContainer.innerHTML = '';
            const galleries = data.galleries || [];
            if (galleries.length === 0) {
                galleriesContainer.innerHTML = '<p>No galleries created.</p>';
                return;
            }
            galleries.forEach((gallery, index) => {
                const galleryDiv = document.createElement('div');
                galleryDiv.className = 'gallery';

                const header = document.createElement('div');
                header.className = 'gallery-header';
                header.setAttribute('data-target', `gallery-${index}`);
                header.innerHTML = `
                    <div>
                        <h3>${gallery.name || `Gallery ${index+1}`}</h3>
                        <div class="gallery-description">${gallery.description || ''}</div>
                        <div class="gallery-tags">üè∑Ô∏è ${(gallery.tags || []).join(' ¬∑ ')}</div>
                    </div>
                    <span style="font-size: 1.5rem;">‚ñº</span>
                `;

                const productsContainer = document.createElement('div');
                productsContainer.id = `gallery-${index}`;
                productsContainer.className = 'gallery-products';
                productsContainer.style.display = 'none';

                if (gallery.products && gallery.products.length) {
                    const table = document.createElement('table');
                    table.innerHTML = `
                        <thead><tr><th>ID</th><th>Name</th><th>Reason</th><th>Score</th></tr></thead>
                        <tbody>
                            ${gallery.products.map(p => `
                                <tr>
                                    <td>${p.id}</td>
                                    <td>${p.name}</td>
                                    <td>${p.reason || ''}</td>
                                    <td><span class="score-badge">${p.score ? p.score.toFixed(2) : ''}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                    productsContainer.appendChild(table);
                } else {
                    productsContainer.innerHTML = '<p>No products in this gallery.</p>';
                }

                header.addEventListener('click', () => {
                    const isVisible = productsContainer.style.display === 'block';
                    productsContainer.style.display = isVisible ? 'none' : 'block';
                    header.querySelector('span').textContent = isVisible ? '‚ñº' : '‚ñ≤';
                });

                galleryDiv.appendChild(header);
                galleryDiv.appendChild(productsContainer);
                galleriesContainer.appendChild(galleryDiv);
            });
        }

        // ---------- Download helpers ----------
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // CSV generators
        function generateFullCSV(data) {
            const galleries = data.galleries || [];
            let csv = "Gallery Name,Gallery Description,Tags,Product ID,Product Name,Reason,Score\n";
            galleries.forEach(gallery => {
                const galleryName = `"${gallery.name.replace(/"/g, '""')}"`;
                const galleryDesc = `"${(gallery.description || '').replace(/"/g, '""')}"`;
                const tags = `"${(gallery.tags || []).join(', ').replace(/"/g, '""')}"`;
                if (gallery.products && gallery.products.length) {
                    gallery.products.forEach(p => {
                        const productId = p.id;
                        const productName = `"${p.name.replace(/"/g, '""')}"`;
                        const reason = `"${(p.reason || '').replace(/"/g, '""')}"`;
                        const score = p.score || '';
                        csv += `${galleryName},${galleryDesc},${tags},${productId},${productName},${reason},${score}\n`;
                    });
                } else {
                    csv += `${galleryName},${galleryDesc},${tags},,,,\n`;
                }
            });
            return csv;
        }

        function generateIDsOnlyCSV(data) {
            const galleries = data.galleries || [];
            let csv = "Gallery Name,Product IDs\n";
            galleries.forEach(gallery => {
                const galleryName = `"${gallery.name.replace(/"/g, '""')}"`;
                const ids = (gallery.products || []).map(p => p.id).join(', ');
                csv += `${galleryName},"${ids}"\n`;
            });
            return csv;
        }

        function generateIDsWithCountCSV(data) {
            const galleries = data.galleries || [];
            let csv = "Gallery Name,Product IDs,Count\n";
            galleries.forEach(gallery => {
                const galleryName = `"${gallery.name.replace(/"/g, '""')}"`;
                const ids = (gallery.products || []).map(p => p.id).join(', ');
                const count = (gallery.products || []).length;
                csv += `${galleryName},"${ids}",${count}\n`;
            });
            return csv;
        }

        function generateCountOnlyCSV(data) {
            const galleries = data.galleries || [];
            let csv = "Gallery Name,Count\n";
            galleries.forEach(gallery => {
                const galleryName = `"${gallery.name.replace(/"/g, '""')}"`;
                const count = (gallery.products || []).length;
                csv += `${galleryName},${count}\n`;
            });
            return csv;
        }

        // JSON generators
        function generateFullJSON(data) {
            return data; // already full structure
        }

        function generateIDsOnlyJSON(data) {
            const galleries = data.galleries || [];
            return galleries.map(g => ({
                name: g.name,
                product_ids: (g.products || []).map(p => p.id)
            }));
        }

        function generateIDsWithCountJSON(data) {
            const galleries = data.galleries || [];
            return galleries.map(g => ({
                name: g.name,
                product_ids: (g.products || []).map(p => p.id),
                count: (g.products || []).length
            }));
        }

        function generateCountOnlyJSON(data) {
            const galleries = data.galleries || [];
            return galleries.map(g => ({
                name: g.name,
                count: (g.products || []).length
            }));
        }

        // Download CSV button
        downloadCsvBtn.addEventListener('click', () => {
            if (!curatedResult) {
                alert('No curated data available. Please curate first.');
                return;
            }
            const format = csvFormatSelect.value;
            let csvContent = '';
            let filename = 'galleries.csv';
            switch (format) {
                case 'full':
                    csvContent = generateFullCSV(curatedResult);
                    filename = 'galleries_full.csv';
                    break;
                case 'ids':
                    csvContent = generateIDsOnlyCSV(curatedResult);
                    filename = 'galleries_ids.csv';
                    break;
                case 'idsCount':
                    csvContent = generateIDsWithCountCSV(curatedResult);
                    filename = 'galleries_ids_count.csv';
                    break;
                case 'count':
                    csvContent = generateCountOnlyCSV(curatedResult);
                    filename = 'galleries_count.csv';
                    break;
                default:
                    csvContent = generateFullCSV(curatedResult);
            }
            downloadCSV(csvContent, filename);
        });

        // Download JSON button
        downloadJsonBtn.addEventListener('click', () => {
            if (!curatedResult) {
                alert('No curated data available. Please curate first.');
                return;
            }
            const format = jsonFormatSelect.value;
            let jsonData = null;
            let filename = 'galleries.json';
            switch (format) {
                case 'full':
                    jsonData = generateFullJSON(curatedResult);
                    filename = 'galleries_full.json';
                    break;
                case 'ids':
                    jsonData = generateIDsOnlyJSON(curatedResult);
                    filename = 'galleries_ids.json';
                    break;
                case 'idsCount':
                    jsonData = generateIDsWithCountJSON(curatedResult);
                    filename = 'galleries_ids_count.json';
                    break;
                case 'count':
                    jsonData = generateCountOnlyJSON(curatedResult);
                    filename = 'galleries_count.json';
                    break;
                default:
                    jsonData = generateFullJSON(curatedResult);
            }
            downloadJSON(jsonData, filename);
        });

        // Copy full JSON to clipboard
        copyJsonBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(rawJsonPre.textContent).then(() => alert('Full JSON copied!'));
        });

        // Top button: Download Combo CSV
        downloadComboBtn.addEventListener('click', () => {
            window.location.href = '/api/download-combo-csv';
        });
    </script>
</body>
</html>