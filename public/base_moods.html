<!DOCTYPE html>
<html>
<head>
    <title>Base Moods - Admin</title>
    <style>
        /* All existing styles ‚Äì only minor additions at the end for the new config panel */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #f0f4f8 0%, #d9e2ec 100%);
            min-height: 100vh;
            padding: 30px;
        }
        .table-container {
            transform: rotateX(180deg);
            -webkit-transform: rotateX(180deg);
        }
        .table-container > * {
            transform: rotateX(180deg);
            -webkit-transform: rotateX(180deg);
        }
        h1 {
            color: #1e2b3a;
            border-bottom: 4px solid #9C27B0;
            padding-bottom: 15px;
            margin-bottom: 25px;
            font-size: 32px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.5px;
        }
        h1:before {
            content: "üé®";
            font-size: 36px;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            padding: 18px 24px;
            border-radius: 16px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.5);
            margin-bottom: 30px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            letter-spacing: 0.3px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .back-btn {
            background: #5a6b7a;
            color: white;
        }
        .refresh-btn {
            background: #2196F3;
            color: white;
        }
        .prompts-btn {
            background: #673AB7;
            color: white;
        }
        .stop-btn {
            background: #dc3545;
            color: white;
        }
        .fix-btn {
            background: #ff9800;
            color: white;
        }
        .download-btn {
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 20px;
        }
        .ai-small {
            background: #9C27B0;
            color: white;
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 20px;
            margin-left: 6px;
            border: none;
            cursor: pointer;
        }
        .placeholder-btn {
            background: #e0e0e0;
            color: #333;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 16px;
            margin-right: 5px;
            margin-bottom: 5px;
            border: none;
            cursor: pointer;
            box-shadow: none;
        }
        .placeholder-btn:hover {
            background: #d0d0d0;
        }
        .copy-btn {
            background: #2196F3;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 16px;
            margin-left: 10px;
            border: none;
            cursor: pointer;
        }

        .search-box {
            flex: 1;
            max-width: 380px;
            position: relative;
        }
        .search-box input {
            width: 100%;
            padding: 12px 48px 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 40px;
            font-size: 15px;
            transition: 0.3s;
            background: white;
        }
        .search-box input:focus {
            outline: none;
            border-color: #9C27B0;
            box-shadow: 0 0 0 4px rgba(156,39,176,0.15);
        }
        .search-box:after {
            content: "üîç";
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
            font-size: 18px;
        }

        .size-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 8px 16px;
            border-radius: 40px;
            border: 2px solid #e0e0e0;
        }
        .size-control label {
            font-weight: 600;
            color: #1e2b3a;
            font-size: 14px;
        }
        .size-control input {
            width: 140px;
        }
        #sizeValue {
            min-width: 45px;
            text-align: center;
            font-weight: 600;
            color: #9C27B0;
        }

        #message {
            padding: 16px 24px;
            border-radius: 40px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
            animation: slideDown 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #loading {
            text-align: center;
            padding: 50px;
            background: #fff8e7;
            border: 2px solid #ffe0a3;
            border-radius: 40px;
            color: #7d5d23;
            font-weight: 600;
            font-size: 18px;
            margin: 30px 0;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        #error {
            padding: 30px;
            background: #ffe6e6;
            border: 2px solid #ffb3b3;
            border-radius: 40px;
            color: #b00020;
            display: none;
            margin: 30px 0;
            font-weight: 500;
        }

        .table-container {
            background: white;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            border-collapse: collapse;
            font-size: 13px;
            min-width: 100%;
        }

        th {
            text-align: left;
            padding: 16px 12px;
            background: #f4f7fb;
            color: #1e2b3a;
            font-weight: 600;
            border-bottom: 3px solid #9C27B0;
            white-space: nowrap;
        }

        td {
            padding: 16px 12px;
            border-bottom: 1px solid #e9ecf0;
            vertical-align: middle;
        }

        .table-img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            border-radius: 8px;
            background: #f0f2f5;
            border: 1px solid #d0d9e2;
            pointer-events: none;
            max-height: 120px;
            transition: max-height 0.1s ease;
        }

        .empty-state {
            text-align: center;
            padding: 80px 30px;
            background: white;
            border-radius: 40px;
            border: 2px dashed #b0c4d9;
            color: #5f7a9a;
            font-size: 20px;
            margin-top: 20px;
        }
        .empty-state:before {
            content: "üé®";
            font-size: 64px;
            display: block;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .column-ai-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 0 4px;
            margin-left: 6px;
            box-shadow: none;
            display: inline;
        }
        .column-ai-btn:hover {
            transform: scale(1.2);
            background: none;
            box-shadow: none;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.25s ease;
        }
        .modal.show {
            display: block;
            opacity: 1;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background: white;
            border-radius: 32px;
            width: 90%;
            max-width: 1000px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }
        .modal.show .modal-content {
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            color: white;
            border-radius: 32px 32px 0 0;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            word-break: break-word;
        }
        .close-modal {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 28px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .close-modal:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 24px;
        }

        .banner-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            background: #f9fafc;
            border: 2px solid #e9ecf0;
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .banner-form .full-width {
            grid-column: span 2;
        }
        .banner-form label {
            font-weight: 600;
            color: #2c3e50;
            display: block;
            margin-bottom: 6px;
        }
        .banner-form input,
        .banner-form textarea,
        .banner-form select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dde3e9;
            border-radius: 16px;
            font-size: 14px;
            transition: 0.2s;
            background: white;
        }
        .banner-form input:focus,
        .banner-form textarea:focus,
        .banner-form select:focus {
            border-color: #9C27B0;
            outline: none;
            box-shadow: 0 0 0 3px rgba(156,39,176,0.1);
        }

        .checklist-search {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dde3e9;
            border-radius: 40px;
            font-size: 14px;
            margin-bottom: 15px;
            background: white;
        }
        .checklist-search:focus {
            border-color: #9C27B0;
            outline: none;
        }
        .mood-checklist {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px;
            background: white;
            border: 2px solid #e9ecf0;
            border-radius: 16px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        .mood-pill {
            display: inline-flex;
            align-items: center;
            background: #f0e6f5;
            border: 2px solid #9C27B0;
            border-radius: 40px;
            padding: 6px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.1s;
            user-select: none;
        }
        .mood-pill input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
            accent-color: #9C27B0;
        }
        .mood-pill:hover {
            background: #d9c4e6;
        }
        .mood-pill .mood-id {
            background: #9C27B0;
            color: white;
            border-radius: 20px;
            padding: 2px 8px;
            margin-left: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .progress-area {
            max-height: 300px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 16px;
            border: 1px solid #ddd;
            margin-top: 20px;
        }

        .img-container {
            position: relative;
            display: inline-block;
        }
        .progress-img {
            width: 100px;
            height: auto;
            border-radius: 8px;
            border: 2px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .img-download {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
        }
        .img-download:hover {
            background: black;
        }

        .post-generation-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: flex-end;
        }
        .approve-btn {
            background: #27ae60;
            color: white;
        }
        .reject-btn {
            background: #e67e22;
            color: white;
        }

        .reject-message {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 16px;
            padding: 15px;
            margin-top: 15px;
            color: #856404;
            font-weight: 500;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .default-prompts {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        .default-prompts pre {
            white-space: pre-wrap;
            background: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .prompt-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .single-field-card {
            background: #f9fafc;
            border: 2px solid #e9ecf0;
            border-radius: 24px;
            padding: 20px;
        }
        .single-field-card .field-label {
            font-weight: 600;
            margin-bottom: 16px;
            color: #2c3e50;
            font-size: 16px;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            background: #eef2f6;
            border-radius: 16px;
            margin-bottom: 16px;
            cursor: pointer;
            border: 1px solid #d0d9e2;
        }
        .image-preview:hover {
            opacity: 0.9;
        }

        .upload-area {
            margin: 16px 0 12px;
        }
        .upload-btn-small {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
            box-shadow: 0 4px 8px rgba(33,150,243,0.2);
        }
        .upload-btn-small:hover {
            background: #1976D2;
        }

        .file-input {
            display: none;
        }

        .uploading-indicator {
            font-size: 13px;
            color: #2196F3;
            margin-top: 8px;
            display: none;
            align-items: center;
            gap: 6px;
        }

        .text-field {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #dde3e9;
            border-radius: 40px;
            font-size: 15px;
            margin-top: 16px;
            background: white;
        }
        .text-field:focus {
            border-color: #9C27B0;
            outline: none;
        }

        .hero-bg-editor {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .carousel-container {
            position: relative;
            text-align: center;
            background: #f0f2f5;
            border-radius: 16px;
            padding: 10px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .carousel-image {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
        }
        .carousel-prev, .carousel-next, .carousel-remove {
            position: absolute;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
            z-index: 10;
        }
        .carousel-prev:hover, .carousel-next:hover, .carousel-remove:hover {
            background: rgba(0,0,0,0.8);
        }
        .carousel-prev {
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        .carousel-next {
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        .carousel-remove {
            right: 10px;
            top: 10px;
            background: #dc3545;
            width: 36px;
            height: 36px;
            font-size: 16px;
        }
        .image-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 120px;
            overflow-y: auto;
            padding: 10px;
            background: #f9fafc;
            border-radius: 12px;
            border: 1px solid #e9ecf0;
        }
        .image-list-item {
            position: relative;
            width: 80px;
            height: 80px;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }
        .image-list-item.selected {
            border-color: #9C27B0;
        }
        .image-list-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-list-item button {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            line-height: 1;
            padding: 0;
            cursor: pointer;
            display: none;
        }
        .image-list-item:hover button {
            display: block;
        }
        .add-image {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .add-image input {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 2px solid #dde3e9;
            border-radius: 40px;
            font-size: 14px;
        }

        .prompts-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .prompts-table th {
            background: #f4f7fb;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #9C27B0;
        }
        .prompts-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecf0;
            vertical-align: top;
        }
        .prompts-table textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }
        .prompts-table .copy-cell-btn {
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 4px 10px;
            font-size: 11px;
            cursor: pointer;
            margin-right: 5px;
        }
        .prompts-table .edit-field {
            display: none;
        }
        .prompts-table .edit-field.active {
            display: block;
        }
        .prompts-table .view-field {
            display: block;
            white-space: pre-wrap;
            max-height: 100px;
            overflow-y: auto;
            background: #f9f9f9;
            padding: 6px;
            border-radius: 4px;
        }
        .prompts-table .view-field.hide {
            display: none;
        }
        .prompt-selection {
            margin-bottom: 20px;
        }
        .prompt-selection label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .selected-prompt-info {
            background: #e9f5e9;
            border: 1px solid #27ae60;
            border-radius: 16px;
            padding: 10px 15px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* New styles for row config panel */
        .config-field-group {
            background: #f9fafc;
            border: 2px solid #e9ecf0;
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .config-field-group h5 {
            margin-bottom: 10px;
            color: #9C27B0;
        }
        .config-field-group .field-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }
        .config-field-group .field-row label {
            font-weight: 600;
            color: #2c3e50;
        }
        .config-field-group input,
        .config-field-group select {
            padding: 8px 12px;
            border: 2px solid #dde3e9;
            border-radius: 40px;
            font-size: 13px;
            background: white;
        }
        .global-inspiration {
            margin: 20px 0;
            padding: 15px;
            background: #f0e6f5;
            border-radius: 16px;
        }
        .global-inspiration label {
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
        }
        .global-inspiration input {
            width: 100%;
            padding: 10px 16px;
            border: 2px solid #9C27B0;
            border-radius: 40px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Base Moods</h1>

    <div class="controls">
        <button class="back-btn" onclick="location.href='/'">‚Üê Dashboard</button>
        <button class="refresh-btn" onclick="loadMoods()">üîÑ Refresh</button>
        <button class="prompts-btn" onclick="openPromptsModal(false)">üìã Prompts</button>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search by name...">
        </div>
        <div class="size-control">
            <label>üîç Image size</label>
            <input type="range" id="imageSizeSlider" min="50" max="200" value="100" step="5">
            <span id="sizeValue">100%</span>
        </div>
    </div>

    <div id="message"></div>
    <div id="loading">‚ú® Loading moods...</div>
    <div id="error"></div>
    <div id="tableContainer" class="table-container"></div>

    <!-- Single Field Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">‚úèÔ∏è Edit Field</h2>
                <button class="close-modal" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-actions" style="display: flex; gap: 16px; justify-content: flex-end; padding: 20px 24px 24px; border-top: 2px solid #eef2f6;">
                <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                <button class="save-btn" onclick="saveSingleField()">üíæ Save</button>
            </div>
        </div>
    </div>

    <!-- Individual Banner AI Generation Modal -->
    <div id="bannerAiModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="bannerAiModalTitle">ü§ñ Generate for <span id="bannerFieldName"></span></h2>
                <button class="close-modal" onclick="closeBannerAIModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="bannerForm" class="banner-form">
                    <input type="hidden" id="bannerField" value="">
                    <div class="full-width">
                        <label>Title</label>
                        <input type="text" id="bannerTitle" value="">
                    </div>
                    <div>
                        <label>Sub Title</label>
                        <input type="text" id="bannerSubTitle" value="">
                    </div>
                    <div>
                        <label>Description</label>
                        <input type="text" id="bannerDescription" value="">
                    </div>
                    <div>
                        <label>CTA</label>
                        <input type="text" id="bannerCta" value="">
                    </div>
                    <div>
                        <label>Background</label>
                        <input type="text" id="bannerBackground" value="mood based">
                    </div>
                    <div>
                        <label>Object</label>
                        <input type="text" id="bannerObject" value="">
                    </div>
                    <div class="full-width">
                        <label>Size</label>
                        <select id="bannerSize">
                            <option value="Landscape" selected>Landscape</option>
                            <option value="Portrait">Portrait</option>
                            <option value="Square">Square</option>
                        </select>
                    </div>
                    <div class="full-width">
                        <label>Inspiration Text</label>
                        <input type="text" id="bannerInspiration" value="Bollywood landscape field">
                    </div>
                </form>

                <!-- Advanced Prompt Settings -->
                <div style="margin: 20px 0; border-top: 2px solid #e0e0e0; padding-top: 20px;">
                    <details>
                        <summary style="font-weight: 600; cursor: pointer; color: #9C27B0;">‚öôÔ∏è Advanced Prompt Settings (optional)</summary>
                        <div style="margin-top: 15px;">
                            <label style="font-weight: 600;">System Prompt (overrides default)</label>
                            <div style="margin-bottom: 10px;">
                                <span style="font-size: 12px; color: #666;">Placeholders:</span>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerSystemPrompt', '{mood}')">{mood}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerSystemPrompt', '{bannerId}')">{bannerId}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerSystemPrompt', '{bannerName}')">{bannerName}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerSystemPrompt', '{title}')">{title}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerSystemPrompt', '{sub_title}')">{sub_title}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerSystemPrompt', '{description}')">{description}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerSystemPrompt', '{cta}')">{cta}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerSystemPrompt', '{background}')">{background}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerSystemPrompt', '{object}')">{object}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerSystemPrompt', '{size}')">{size}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerSystemPrompt', '{inspiration}')">{inspiration}</button>
                            </div>
                            <textarea id="bannerSystemPrompt" rows="4" style="width: 100%; padding: 12px; border-radius: 16px; border: 2px solid #dde3e9; font-family: monospace; font-size: 13px; margin-bottom: 15px;" placeholder="Leave empty to use default system prompt"></textarea>

                            <label style="font-weight: 600;">User Prompt Template</label>
                            <div style="margin-bottom: 10px;">
                                <span style="font-size: 12px; color: #666;">Placeholders:</span>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerUserPromptTemplate', '{mood}')">{mood}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerUserPromptTemplate', '{bannerId}')">{bannerId}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerUserPromptTemplate', '{bannerName}')">{bannerName}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerUserPromptTemplate', '{title}')">{title}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerUserPromptTemplate', '{sub_title}')">{sub_title}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerUserPromptTemplate', '{description}')">{description}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerUserPromptTemplate', '{cta}')">{cta}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerUserPromptTemplate', '{background}')">{background}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerUserPromptTemplate', '{object}')">{object}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerUserPromptTemplate', '{size}')">{size}</button>
                                <button class="placeholder-btn" onclick="insertPlaceholder('bannerUserPromptTemplate', '{inspiration}')">{inspiration}</button>
                            </div>
                            <textarea id="bannerUserPromptTemplate" rows="4" style="width: 100%; padding: 12px; border-radius: 16px; border: 2px solid #dde3e9; font-family: monospace; font-size: 13px;" placeholder="Leave empty to use default user prompt"></textarea>

                            <button class="fix-btn" style="margin-top: 10px;" onclick="toggleDefaultPrompts('banner')">üìã Show Default Prompts</button>
                            <div id="bannerDefaultPrompts" class="default-prompts">
                                <div class="prompt-header">
                                    <h4>Default System Prompt</h4>
                                    <button class="copy-btn" onclick="copyToClipboard(defaultSystemPrompt)">Copy</button>
                                </div>
                                <pre>Zulu Club ‚Äî Mood-Driven Banner Generation Engine ...</pre>
                                <div class="prompt-header">
                                    <h4>Default User Prompt</h4>
                                    <button class="copy-btn" onclick="copyToClipboard(defaultUserPrompt)">Copy</button>
                                </div>
                                <pre>Zulu Club ‚Äî Mood-Based Banner Generation ...</pre>
                            </div>
                        </div>
                    </details>
                </div>

                <div id="bannerProgressArea" style="margin-top: 20px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4>Generated Images</h4>
                        <div>
                            <button class="stop-btn" id="bannerStopBtn" onclick="stopBannerGeneration()" style="display: none;">‚èπÔ∏è Stop</button>
                        </div>
                    </div>
                    <div id="bannerProgress" style="max-height: 300px; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 10px; background: #f5f5f5; padding: 10px; border-radius: 16px;"></div>
                    <div id="bannerStatus" style="margin-top: 10px; font-weight: 500;"></div>
                </div>
            </div>
            <div class="modal-actions" style="display: flex; gap: 16px; justify-content: flex-end; padding: 20px 24px 24px; border-top: 2px solid #eef2f6;">
                <button class="cancel-btn" onclick="closeBannerAIModal()">Cancel</button>
                <button class="save-btn" onclick="startBannerGeneration()" style="background: #9C27B0;">‚ú® Generate All 6 Moods</button>
            </div>
        </div>
    </div>

    <!-- Column AI Modal -->
    <div id="columnAiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="columnAiTitle">ü§ñ Generate for <span id="columnFieldName"></span></h2>
                <button class="close-modal" onclick="closeColumnAIModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;">Select which moods you want to generate.</p>
                
                <input type="text" id="moodSearch" class="checklist-search" placeholder="Search moods...">
                <div id="columnMoodChecklist" class="mood-checklist"></div>

                <div style="margin: 20px 0;">
                    <button class="fix-btn" onclick="openPromptsModal(true)" style="margin-right: 10px;">üìã Select Prompts</button>
                    <span id="selectedPromptName" style="font-weight: 500;"></span>
                </div>
                <input type="hidden" id="selectedPromptId" value="">

                <form id="columnBannerForm" class="banner-form">
                    <input type="hidden" id="columnField" value="">
                    <div class="full-width">
                        <label>Title</label>
                        <input type="text" id="columnTitle" value="">
                    </div>
                    <div>
                        <label>Sub Title</label>
                        <input type="text" id="columnSubTitle" value="">
                    </div>
                    <div>
                        <label>Description</label>
                        <input type="text" id="columnDescription" value="">
                    </div>
                    <div>
                        <label>CTA</label>
                        <input type="text" id="columnCta" value="">
                    </div>
                    <div>
                        <label>Background</label>
                        <input type="text" id="columnBackground" value="mood based">
                    </div>
                    <div>
                        <label>Object</label>
                        <input type="text" id="columnObject" value="">
                    </div>
                    <div class="full-width">
                        <label>Size</label>
                        <select id="columnSize">
                            <option value="Landscape" selected>Landscape</option>
                            <option value="Portrait">Portrait</option>
                            <option value="Square">Square</option>
                        </select>
                    </div>
                    <div class="full-width">
                        <label>Inspiration Text</label>
                        <input type="text" id="columnInspiration" value="Bollywood landscape field">
                    </div>
                </form>

                <div id="columnProgressArea" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4>Generated Images</h4>
                        <div>
                            <button class="stop-btn" id="columnStopBtn" onclick="stopColumnGeneration()" style="display: none;">‚èπÔ∏è Stop</button>
                        </div>
                    </div>
                    <div id="columnProgress" class="progress-area"></div>
                    <div id="columnStatus" style="margin-top: 10px; font-weight: 500;"></div>

                    <div id="postGenActions" style="display: none;" class="post-generation-actions">
                        <button class="approve-btn" onclick="approveGeneration()">‚úÖ Approve & Save to DB</button>
                        <button class="reject-btn" onclick="rejectGeneration()">‚ùå Reject (Download CSV only)</button>
                    </div>
                    <div id="rejectMessage" class="reject-message">
                        ‚è≥ Please manually delete the unwanted images from cloud storage. This message will disappear in 5 seconds...
                    </div>
                </div>
            </div>
            <div class="modal-actions" style="display: flex; gap: 16px; justify-content: flex-end; padding: 20px 24px 24px; border-top: 2px solid #eef2f6;">
                <button class="cancel-btn" onclick="closeColumnAIModal()">Close</button>
                <button class="save-btn" onclick="startColumnGeneration()" style="background: #9C27B0;">‚ú® Generate Selected Moods</button>
            </div>
        </div>
    </div>

    <!-- ========== Row AI Modal (with configuration panel) ========== -->
    <div id="rowAiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="rowAiTitle">ü§ñ Generate for <span id="rowMoodName"></span></h2>
                <button class="close-modal" onclick="closeRowAIModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;">Select which banner fields you want to generate for this mood.</p>
                
                <input type="text" id="fieldSearch" class="checklist-search" placeholder="Search fields...">
                <div id="fieldChecklist" class="mood-checklist"></div>

                <!-- Button to open configuration panel -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="fix-btn" onclick="showRowConfigPanel()">‚öôÔ∏è Configure Selected</button>
                </div>

                <!-- Configuration panel (hidden by default) -->
                <div id="rowConfigPanel" style="display: none; margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
                    <h4 style="margin-bottom: 15px;">Customise banner texts for each selected field</h4>
                    
                    <!-- Global Inspiration Text -->
                    <div class="global-inspiration">
                        <label for="globalInspirationInput">üåç Global Inspiration Text (applies to all selected fields)</label>
                        <input type="text" id="globalInspirationInput" value="Bollywood landscape field" placeholder="e.g. Bollywood landscape field">
                    </div>

                    <div id="rowConfigList"></div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="save-btn" onclick="saveRowConfigs()">üíæ Save Configurations</button>
                        <button class="cancel-btn" onclick="hideRowConfigPanel()">Cancel</button>
                    </div>
                </div>

                <!-- Progress area -->
                <div id="rowProgressArea" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4>Generated Images</h4>
                        <div>
                            <button class="stop-btn" id="rowStopBtn" onclick="stopRowGeneration()" style="display: none;">‚èπÔ∏è Stop</button>
                        </div>
                    </div>
                    <div id="rowProgress" class="progress-area"></div>
                    <div id="rowStatus" style="margin-top: 10px; font-weight: 500;"></div>

                    <div id="rowPostGenActions" style="display: none;" class="post-generation-actions">
                        <button class="approve-btn" onclick="approveRowGeneration()">‚úÖ Approve & Save to DB</button>
                        <button class="reject-btn" onclick="rejectRowGeneration()">‚ùå Reject (Download CSV only)</button>
                    </div>
                    <div id="rowRejectMessage" class="reject-message">
                        ‚è≥ Please manually delete the unwanted images from cloud storage. This message will disappear in 5 seconds...
                    </div>
                </div>
            </div>
            <div class="modal-actions" style="display: flex; gap: 16px; justify-content: flex-end; padding: 20px 24px 24px; border-top: 2px solid #eef2f6;">
                <button class="cancel-btn" onclick="closeRowAIModal()">Close</button>
                <button class="save-btn" onclick="startRowGeneration()" style="background: #9C27B0;">‚ú® Generate Selected Fields</button>
            </div>
        </div>
    </div>

    <!-- Prompts Modal -->
    <div id="promptsModal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2 id="promptsModalTitle">üìã Prompts</h2>
                <button class="close-modal" onclick="closePromptsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="promptsTableContainer"></div>
            </div>
            <div class="modal-actions" style="display: flex; gap: 16px; justify-content: flex-end; padding: 20px 24px 24px; border-top: 2px solid #eef2f6;">
                <button class="cancel-btn" onclick="closePromptsModal()">Close</button>
                <button id="promptsSelectBtn" class="save-btn" style="background: #9C27B0; display: none;" onclick="selectPrompt()">Select</button>
            </div>
        </div>
    </div>

    <script>
        // ----- Default prompts (full versions) ‚Äì truncated for brevity, replace with actual prompts -----
        const defaultSystemPrompt = `Zulu Club ‚Äî Mood-Driven Banner Generation Engine

You are generating premium lifestyle banners for Zulu Club, a mood-based shopping app.

Each banner must help users navigate feelings and intent, not just products.

üî¢ SCALE & EXPECTATION (NON-NEGOTIABLE)

Total Banner Rows: 11

Total Moods: 6

Total Images to Generate: 66

For EACH Banner ID, you must generate 6 images, one per mood:

CALM

NOSTALGIC

PLAYFUL

CONFIDENT

AMBITIOUS

INTROSPECTIVE

These 6 images must feel like emotional variations of the same idea,
not 6 unrelated designs.

üü• ABSOLUTE PRIORITY RULES (OVERRIDE ALL)

ZERO spelling mistakes

Text must match DATA_TABLE fields exactly

No paraphrasing

Text placement

Title and Sub Title

Always on the LEFT

Clear margin from TOP + LEFT

LEFT-ALIGNED only

Prominent and readable

Object placement

Always BOTTOM-CENTER to BOTTOM-RIGHT

Never overlaps text

CTA placement

Only BOTTOM-LEFT or BOTTOM-RIGHT

Consistent margins

No overlap

Description placement

Either:

Directly below Sub Title, OR

Near CTA (if visually appropriate)

Mood integrity

Mood drives:

Background

Lighting

Color palette

Texture

Typography feel

No drastic shocks between moods

Emotional flow must feel natural while scrolling

Typography inspiration (STRICT)

CALM ‚Üí Lato

NOSTALGIC ‚Üí Playfair Display

PLAYFUL ‚Üí Montserrat

CONFIDENT ‚Üí Inter

AMBITIOUS ‚Üí Klein

INTROSPECTIVE ‚Üí Cormorant Garamond

üü¶ INPUT A ‚Äî DATA_TABLE (SOURCE OF TRUTH)

Each row represents one banner concept.

For each row, you must generate 6 mood variants.

Columns (use exactly):

Banner ID

Banner Name

Size

Title

Sub Title

Description

CTA

Background

Object

üü© INPUT B ‚Äî INSPIRATION_TEXT

Defines the emotional philosophy behind:

Every pixel

Every object

Every word

This ensures brand soul consistency across all 66 images.

üü® INPUT C ‚Äî INSPIRATION_IMAGE

Defines:

Realism

Texture quality

Lighting maturity

Lifestyle authenticity

All outputs must feel like they belong to the same visual universe.

üü™ INPUT D ‚Äî MOOD_BASED_GUIDELINE_NOTE

Defines how each mood is expressed.

Only the active mood‚Äôs guideline should be applied per image.

üé≠ MOOD FLOW RULE (VERY IMPORTANT)

When generating the 6 moods for the same banner:

Composition stays structurally consistent

Object identity stays the same

Camera angle stays similar

Changes happen via:

Lighting

Color temperature

Contrast

Emotional energy

This ensures:

Users feel emotional progression, not disorientation.

üßæ OUTPUT STRUCTURE (STRICT)
üìÅ Folder Structure
/ZuluClub_Banners/
  /Banner_<Banner ID>_<Banner Name>/

üìÑ Filename Convention (MANDATORY)
<BannerName>_<Mood>.png

Example
Deliver_ASAP_CALM.png
Deliver_ASAP_NOSTALGIC.png
Deliver_ASAP_PLAYFUL.png
Deliver_ASAP_CONFIDENT.png
Deliver_ASAP_AMBITIOUS.png
Deliver_ASAP_INTROSPECTIVE.png


Repeat for all 11 banners ‚Üí 66 total images

üñºÔ∏è VISUAL STYLE (GLOBAL)

Ultra-realistic

Premium lifestyle

Editorial, not ecommerce-noisy

Clean negative space on the LEFT

No illustration unless explicitly implied

No clutter

No gimmicks

‚úÖ FINAL SELF-CHECK (MANDATORY)

Before finalizing each image:

No spelling errors

Correct alignment

No overlaps

Object bottom-center/right

CTA correctly placed

Mood instantly recognizable

Feels like Zulu Club, not generic

üîí FINAL STATUS

This system now guarantees:

66 coherent images

Strong mood storytelling

Visual consistency across navigation

Emotional continuity without shock

Scalable banner generation`;

        const defaultUserPrompt = `Zulu Club ‚Äî Mood-Based Banner Generation

You are generating ONE image for a 6-mood banner set.

üî¢ Context
Total moods per banner: 6
This image represents ONLY the "{mood}" mood variant.
All 6 variants must feel like emotional progressions of the SAME concept.

üÜî Banner Details (Source of Truth ‚Äî Use EXACT Text)
Mood: {mood}
Typography (STRICT): [varies by mood]

Banner ID: {bannerId}
Banner Name: {bannerName}
Size: {size}

Title: {title}
Sub Title: {sub_title}
Description: {description}
CTA: {cta}

Background: {background}
Object: {object}

Inspiration Philosophy:
{inspiration}

üü• ABSOLUTE TEXT RULES (OVERRIDE ALL)
- ZERO spelling mistakes.
- Text must match Title, Sub Title, Description, CTA EXACTLY as provided.
- NO paraphrasing.
- Preserve capitalization exactly.
üß± LAYOUT STRUCTURE (MANDATORY)
- Title and Sub Title:
  ‚Ä¢ ALWAYS on LEFT
  ‚Ä¢ Clear margin from TOP and LEFT
  ‚Ä¢ LEFT-ALIGNED only
  ‚Ä¢ Prominent and readable
- Description:
  ‚Ä¢ Either directly below Sub Title
  ‚Ä¢ OR placed near CTA (if visually stronger)
- Object:
  ‚Ä¢ ALWAYS bottom-center to bottom-right
  ‚Ä¢ NEVER overlap text
  ‚Ä¢ Maintain same object identity across all moods
- CTA:
  ‚Ä¢ Only bottom-left OR bottom-right
  ‚Ä¢ Consistent margins
  ‚Ä¢ No overlap

üé≠ MOOD EXECUTION RULE
Composition must remain structurally consistent with other 5 moods.
Camera angle must remain similar.
Object placement must remain similar.

Mood variation happens ONLY through:
- Lighting
- Color temperature
- Contrast
- Texture feel
- Emotional energy
- Typography personality (STRICT mood font)

Mood must drive:
- Background atmosphere
- Lighting maturity
- Color palette
- Texture depth
- Typography feel

No drastic shocks between moods.
Emotional flow must feel natural when scrolling through all 6.

üñºÔ∏è GLOBAL VISUAL STYLE
- Ultra-realistic
- Premium lifestyle
- Editorial (not ecommerce noisy)
- Clean negative space on LEFT
- No clutter
- No gimmicks
- No illustration unless explicitly required

üîé FINAL SELF-CHECK (MANDATORY BEFORE OUTPUT)
- No spelling errors
- Exact text match
- Correct alignment
- No overlaps
- Object bottom-center/right
- CTA correctly placed
- Mood instantly recognizable
- Feels like Zulu Club visual universe

Generate only the "{mood}" variant image for this banner.`;

        // ----- Helper functions -----
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('‚úÖ Copied to clipboard', 'success');
            }).catch(err => {
                showMessage('‚ùå Failed to copy', 'error');
            });
        }

        function insertPlaceholder(textareaId, placeholder) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const newText = text.substring(0, start) + placeholder + text.substring(end);
            textarea.value = newText;
            textarea.selectionStart = textarea.selectionEnd = start + placeholder.length;
            textarea.focus();
        }

        function toggleDefaultPrompts(modal) {
            const div = document.getElementById(modal + 'DefaultPrompts');
            if (div.style.display === 'none' || div.style.display === '') {
                div.style.display = 'block';
            } else {
                div.style.display = 'none';
            }
        }

        // ----- Global variables -----
        let allMoods = [];
        let currentEditMoodId = null;
        let currentEditField = null;
        let slideshowIntervals = [];
        const BASE_IMAGE_SIZE = 120;
        let currentHeroUrls = [];
        let currentHeroIndex = 0;

        const bannerFieldMap = {
            1: 'deliver_asap',
            2: 'category_banner',
            3: 'visit_us',
            4: 'concierge',
            5: 'home_banner',
            6: 'watch_banner',
            7: 'visit_banner',
            8: 'listen_banner',
            9: 'cart_banner',
            10: 'profile_bg',
            11: 'hero_bg',
            12: 'logos',
            13: 'visit2_bg',
            14: 'watch2_bg',
            15: 'decorate2_bg',
            16: 'ask_zulu2_bg',
            17: 'sound2_bg',
            18: 'concierge2_bg'
        };

        const fieldToBannerId = {};
        for (const [id, field] of Object.entries(bannerFieldMap)) {
            fieldToBannerId[field] = parseInt(id);
        }

        const bannerDefaults = {
            1: { title: "We deliver", sub_title: "ASAP", description: "or less", cta: "100 MINS", background: "mood based", object: "Hard paper shopping bag" },
            2: { title: "Discover all", sub_title: "Categories", description: "", cta: "SHOP NOW", background: "mood based", object: "Life style objects as per mood" },
            3: { title: "Golf Course Extn", sub_title: "Sec 65", description: "Near World Mark", cta: "Gurgaon", background: "mood based", object: "Showroom" },
            4: { title: "Decorate your home", sub_title: "with AI", description: "", cta: "START", background: "mood based", object: "AI Decorates your home" },
            5: { title: "Your daily dose", sub_title: "of Happiness", description: "YOUR VIBE", cta: "DISCOVER", background: "mood based", object: "Life style couch vibe" },
            6: { title: "The best of", sub_title: "Life & Style", description: "Near You", cta: "", background: "mood based", object: "Life style videos in a mobile app" },
            7: { title: "Life style", sub_title: "Outlets", description: "across Gurgram", cta: "", background: "mood based", object: "Life style markets & malls" },
            8: { title: "Feel", sub_title: "the Music", description: "Get Excited", cta: "", background: "mood based", object: "Life style music & mood based feelings" },
            9: { title: "Rs 500 off", sub_title: "on your 1st order", description: "", cta: "ORDER NOW", background: "mood based", object: "Life style checkout" },
            10: { title: "Your wish", sub_title: "is our command", description: "", cta: "CHAT NOW", background: "mood based", object: "Concierge bell" },
            11: { title: "", sub_title: "", description: "", cta: "", background: "mood based landscape scenes", object: "" },
            12: { title: "", sub_title: "", description: "", cta: "", background: "mood based landscape scenes", object: "" },
            13:{ title: "Visit us", sub_title: "near you", description: "", cta: "EXPLORE", background: "mood based", object: "Retail experience & showroom visit" },
            14:{ title: "Watch & get inspired", sub_title: "in real time", description: "", cta: "WATCH NOW", background: "mood based", object: "Lifestyle video inspiration" },
            15:{ title: "Decor made easy", sub_title: "with AI magic", description: "", cta: "TRY NOW", background: "mood based", object: "AI-powered decor visualization" },
            16:{ title: "Ask Zulu", sub_title: "anything", description: "", cta: "ASK NOW", background: "mood based", object: "AI assistant interaction" },
            17:{ title: "Feel the sound", sub_title: "match your mood", description: "", cta: "LISTEN", background: "mood based", object: "Mood-based audio & sound vibes" },
            18:{ title: "Your personal", sub_title: "concierge", description: "", cta: "CONNECT", background: "mood based", object: "Premium concierge service" }
        };

        const moodNameToId = {
            'nostalgic': 1,
            'playful': 2,
            'confident': 3,
            'calm': 4,
            'ambitious': 5,
            'introspective': 6
        };

        function showMessage(text, type = 'success') {
            const msg = document.getElementById('message');
            msg.textContent = text;
            const colors = {
                success: { bg: '#d4edda', color: '#155724' },
                error: { bg: '#f8d7da', color: '#721c24' },
                info: { bg: '#d1ecf1', color: '#0c5460' }
            };
            const s = colors[type] || colors.success;
            msg.style.backgroundColor = s.bg;
            msg.style.color = s.color;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 4000);
        }

        // ---------- Prompts Management ----------
        let promptsData = [];
        let promptsModalSelectMode = false;

        async function loadPrompts() {
            try {
                const res = await fetch('/api/prompts');
                const data = await res.json();
                if (data.success) {
                    promptsData = data.data;
                } else {
                    showMessage('Failed to load prompts', 'error');
                }
            } catch (err) {
                showMessage('Error loading prompts: ' + err.message, 'error');
            }
        }

        function renderPromptsTable(selectMode) {
            const container = document.getElementById('promptsTableContainer');
            let html = '<table class="prompts-table"><thead><tr>';
            if (selectMode) html += '<th>Select</th>';
            html += '<th>ID</th><th>Name</th><th>System Prompt</th><th>User Prompt</th><th>Comments</th><th>Actions</th></tr></thead><tbody>';

            promptsData.forEach(p => {
                html += '<tr>';
                if (selectMode) {
                    html += `<td><input type="radio" name="selectedPrompt" value="${p.id}" data-system="${escapeHtml(p.system_prompt)}" data-user="${escapeHtml(p.user_prompt)}" data-name="${escapeHtml(p.name)}"></td>`;
                }
                html += `<td>${p.id}</td>`;
                // Name field (editable inline)
                html += `<td><div class="view-field" id="view-name-${p.id}">${escapeHtml(p.name)}</div>
                        <textarea class="edit-field" id="edit-name-${p.id}" rows="1">${escapeHtml(p.name)}</textarea></td>`;
                // System prompt
                html += `<td><div class="view-field" id="view-system-${p.id}">${escapeHtml(p.system_prompt || '')}</div>
                        <textarea class="edit-field" id="edit-system-${p.id}" rows="3">${escapeHtml(p.system_prompt || '')}</textarea></td>`;
                // User prompt
                html += `<td><div class="view-field" id="view-user-${p.id}">${escapeHtml(p.user_prompt || '')}</div>
                        <textarea class="edit-field" id="edit-user-${p.id}" rows="3">${escapeHtml(p.user_prompt || '')}</textarea></td>`;
                // Comments
                html += `<td><div class="view-field" id="view-comments-${p.id}">${escapeHtml(p.comments || '')}</div>
                        <textarea class="edit-field" id="edit-comments-${p.id}" rows="2">${escapeHtml(p.comments || '')}</textarea></td>`;
                // Actions
                html += `<td>
                    <button class="copy-btn" onclick="copyPromptField('system', ${p.id})">üìã Sys</button>
                    <button class="copy-btn" onclick="copyPromptField('user', ${p.id})">üìã User</button>
                    <button class="copy-btn" onclick="copyPromptField('comments', ${p.id})">üìã Comm</button>
                    <button class="edit-btn" onclick="editPromptField(${p.id})">‚úèÔ∏è</button>
                    <button class="save-btn" style="display:none;" id="save-${p.id}" onclick="savePromptField(${p.id})">üíæ</button>
                </td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        window.copyPromptField = function(field, id) {
            const text = promptsData.find(p => p.id == id)[field === 'system' ? 'system_prompt' : field === 'user' ? 'user_prompt' : 'comments'] || '';
            copyToClipboard(text);
        };

        window.editPromptField = function(id) {
            document.querySelectorAll(`#view-name-${id}, #view-system-${id}, #view-user-${id}, #view-comments-${id}`).forEach(el => el.classList.add('hide'));
            document.querySelectorAll(`#edit-name-${id}, #edit-system-${id}, #edit-user-${id}, #edit-comments-${id}`).forEach(el => el.classList.add('active'));
            document.getElementById(`save-${id}`).style.display = 'inline-flex';
        };

        window.savePromptField = async function(id) {
            const updated = {
                name: document.getElementById(`edit-name-${id}`).value,
                system_prompt: document.getElementById(`edit-system-${id}`).value,
                user_prompt: document.getElementById(`edit-user-${id}`).value,
                comments: document.getElementById(`edit-comments-${id}`).value
            };
            try {
                const res = await fetch(`/api/prompts/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updated)
                });
                const data = await res.json();
                if (data.success) {
                    showMessage('Prompt updated', 'success');
                    // Update local data
                    const p = promptsData.find(p => p.id == id);
                    Object.assign(p, updated);
                    // Switch back to view mode
                    document.querySelectorAll(`#view-name-${id}, #view-system-${id}, #view-user-${id}, #view-comments-${id}`).forEach(el => el.classList.remove('hide'));
                    document.querySelectorAll(`#edit-name-${id}, #edit-system-${id}, #edit-user-${id}, #edit-comments-${id}`).forEach(el => el.classList.remove('active'));
                    document.getElementById(`save-${id}`).style.display = 'none';
                    // Update displayed text
                    document.getElementById(`view-name-${id}`).innerText = updated.name;
                    document.getElementById(`view-system-${id}`).innerText = updated.system_prompt;
                    document.getElementById(`view-user-${id}`).innerText = updated.user_prompt;
                    document.getElementById(`view-comments-${id}`).innerText = updated.comments;
                } else {
                    showMessage('Update failed', 'error');
                }
            } catch (err) {
                showMessage('Error: ' + err.message, 'error');
            }
        };

        async function openPromptsModal(selectMode) {
            await loadPrompts();
            promptsModalSelectMode = selectMode;
            document.getElementById('promptsModalTitle').innerText = selectMode ? 'Select a Prompt' : 'Prompts';
            renderPromptsTable(selectMode);
            document.getElementById('promptsSelectBtn').style.display = selectMode ? 'inline-flex' : 'none';
            document.getElementById('promptsModal').classList.add('show');
        }

        function closePromptsModal() {
            document.getElementById('promptsModal').classList.remove('show');
        }

        // Updated selectPrompt to handle field-specific selection
        function selectPrompt() {
            const selected = document.querySelector('input[name="selectedPrompt"]:checked');
            if (!selected) {
                alert('Please select a prompt');
                return;
            }
            const promptId = selected.value;
            const promptName = selected.dataset.name;
            const systemPrompt = selected.dataset.system;
            const userPrompt = selected.dataset.user;

            // If we are in row config mode (field set)
            if (window._currentPromptField) {
                const field = window._currentPromptField;
                if (!rowGenerationState.fieldConfigs[field]) {
                    rowGenerationState.fieldConfigs[field] = {};
                }
                rowGenerationState.fieldConfigs[field].prompt = {
                    id: promptId,
                    name: promptName,
                    system: systemPrompt,
                    user: userPrompt
                };
                // Update the display in config panel
                const span = document.getElementById(`prompt-name-${field}`);
                if (span) span.innerText = escapeHtml(promptName);
                window._currentPromptField = null;
                closePromptsModal();
                return;
            }

            // Otherwise, handle column AI selection (existing)
            document.getElementById('selectedPromptId').value = promptId;
            document.getElementById('selectedPromptName').innerHTML = `Selected: <strong>${escapeHtml(promptName)}</strong> (ID: ${promptId})`;
            if (columnGenerationState) {
                columnGenerationState.selectedPrompt = { id: promptId, system: systemPrompt, user: userPrompt, name: promptName };
            }
            closePromptsModal();
        }

        // ---------- Column AI Modal State (unchanged) ----------
        let columnGenerationState = {
            field: null,
            abortController: null,
            isGenerating: false,
            links: [],
            selectedMoodNames: [],
            completed: false,
            selectedPrompt: null
        };

        function renderMoodChecklist(filter = '') {
            const container = document.getElementById('columnMoodChecklist');
            const searchTerm = filter.toLowerCase();
            let html = '';
            allMoods.forEach(mood => {
                const moodName = mood.name || `Mood ${mood.id}`;
                if (moodName.toLowerCase().includes(searchTerm)) {
                    html += `<label class="mood-pill">
                        <input type="checkbox" value="${mood.id}" data-mood-name="${mood.name ? mood.name.toLowerCase() : ''}">
                        ${escapeHtml(moodName)} <span class="mood-id">${mood.id}</span>
                    </label>`;
                }
            });
            if (!html) {
                html = '<div class="no-results">No matching moods</div>';
            }
            container.innerHTML = html;
        }

        function openColumnAIModal(field) {
            const bannerId = fieldToBannerId[field];
            if (!bannerId) {
                alert('Unknown field');
                return;
            }
            const defaults = bannerDefaults[bannerId] || {};

            document.getElementById('columnField').value = field;
            document.getElementById('columnFieldName').innerText = field;
            document.getElementById('columnTitle').value = defaults.title || '';
            document.getElementById('columnSubTitle').value = defaults.sub_title || '';
            document.getElementById('columnDescription').value = defaults.description || '';
            document.getElementById('columnCta').value = defaults.cta || '';
            document.getElementById('columnBackground').value = defaults.background || 'mood based';
            document.getElementById('columnObject').value = defaults.object || '';
            document.getElementById('columnSize').value = 'Landscape';
            document.getElementById('columnInspiration').value = 'Bollywood landscape field';
            document.getElementById('selectedPromptId').value = '';
            document.getElementById('selectedPromptName').innerHTML = '';

            renderMoodChecklist();

            const searchInput = document.getElementById('moodSearch');
            searchInput.value = '';
            searchInput.oninput = (e) => renderMoodChecklist(e.target.value);

            if (columnGenerationState.field !== field || !columnGenerationState.isGenerating) {
                columnGenerationState = {
                    field: null,
                    abortController: null,
                    isGenerating: false,
                    links: [],
                    selectedMoodNames: [],
                    completed: false,
                    selectedPrompt: null
                };
                document.getElementById('columnProgressArea').style.display = 'none';
                document.getElementById('postGenActions').style.display = 'none';
                document.getElementById('rejectMessage').style.display = 'none';
                document.getElementById('columnProgress').innerHTML = '';
                document.getElementById('columnStatus').innerText = '';
            } else {
                document.getElementById('columnProgress').innerHTML = '';
                columnGenerationState.links.forEach(link => addImageToProgress(link));
                document.getElementById('columnProgressArea').style.display = 'block';
                document.getElementById('columnStopBtn').style.display = 'inline-flex';
                document.getElementById('postGenActions').style.display = 'none';
                document.getElementById('columnStatus').innerText = 'Generation in progress...';
                if (columnGenerationState.selectedPrompt) {
                    document.getElementById('selectedPromptId').value = columnGenerationState.selectedPrompt.id;
                    document.getElementById('selectedPromptName').innerHTML = `Selected: <strong>${columnGenerationState.selectedPrompt.name}</strong> (ID: ${columnGenerationState.selectedPrompt.id})`;
                }
            }

            document.getElementById('columnAiModal').classList.add('show');
        }

        function closeColumnAIModal() {
            document.getElementById('columnAiModal').classList.remove('show');
        }

        function addImageToProgress(link) {
            const progressDiv = document.getElementById('columnProgress');
            const container = document.createElement('div');
            container.className = 'img-container';
            const img = document.createElement('img');
            img.src = link.url;
            img.className = 'progress-img';
            img.title = `${link.bannerName} - ${link.mood}`;
            container.appendChild(img);
            const downloadLink = document.createElement('a');
            downloadLink.href = link.url;
            downloadLink.download = `${link.bannerName}_${link.mood}.png`;
            downloadLink.className = 'img-download';
            downloadLink.innerHTML = '‚¨áÔ∏è';
            downloadLink.onclick = (e) => e.stopPropagation();
            container.appendChild(downloadLink);
            progressDiv.appendChild(container);
        }

        async function startColumnGeneration() {
            const field = document.getElementById('columnField').value;
            const bannerId = fieldToBannerId[field];
            if (!bannerId) return;

            const checkboxes = document.querySelectorAll('#columnMoodChecklist input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one mood.');
                return;
            }
            const selectedMoodNames = Array.from(checkboxes).map(cb => cb.dataset.moodName).filter(name => name);

            const bannerData = {
                banner_id: bannerId,
                banner_name: field.replace(/_/g, ' '),
                size: document.getElementById('columnSize').value,
                title: document.getElementById('columnTitle').value,
                sub_title: document.getElementById('columnSubTitle').value,
                description: document.getElementById('columnDescription').value,
                cta: document.getElementById('columnCta').value,
                background: document.getElementById('columnBackground').value,
                object: document.getElementById('columnObject').value
            };
            const inspiration = document.getElementById('columnInspiration').value;

            let systemPrompt = undefined;
            let userTemplate = undefined;
            if (columnGenerationState.selectedPrompt) {
                systemPrompt = columnGenerationState.selectedPrompt.system;
                userTemplate = columnGenerationState.selectedPrompt.user;
            }

            const requestJson = {
                version: "1.0",
                total_banners: 1,
                banners: [bannerData],
                moods: selectedMoodNames
            };

            columnGenerationState.field = field;
            columnGenerationState.links = [];
            columnGenerationState.selectedMoodNames = selectedMoodNames;
            columnGenerationState.completed = false;
            document.getElementById('columnProgress').innerHTML = '';
            document.getElementById('columnStatus').innerText = '';
            document.getElementById('columnProgressArea').style.display = 'block';
            document.getElementById('columnStopBtn').style.display = 'inline-flex';
            document.getElementById('postGenActions').style.display = 'none';
            document.getElementById('rejectMessage').style.display = 'none';

            columnGenerationState.abortController = new AbortController();
            columnGenerationState.isGenerating = true;

            const statusDiv = document.getElementById('columnStatus');

            try {
                const response = await fetch('/api/ai/generate-banners', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    signal: columnGenerationState.abortController.signal,
                    body: JSON.stringify({ 
                        json: requestJson, 
                        inspiration,
                        systemPrompt,
                        userPromptTemplate: userTemplate
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    statusDiv.innerText = '‚ùå Error: ' + err.error;
                    columnGenerationState.isGenerating = false;
                    document.getElementById('columnStopBtn').style.display = 'none';
                    return;
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            if (data.error) {
                                statusDiv.innerText = '‚ùå Error: ' + data.error;
                                columnGenerationState.isGenerating = false;
                                document.getElementById('columnStopBtn').style.display = 'none';
                                return;
                            }
                            if (data.done) {
                                statusDiv.innerText = `‚úÖ Generation completed for ${field}.`;
                                document.getElementById('columnStopBtn').style.display = 'none';
                                document.getElementById('postGenActions').style.display = 'flex';
                                columnGenerationState.isGenerating = false;
                                columnGenerationState.completed = true;
                                break;
                            }
                            const link = {
                                bannerId: data.bannerId,
                                bannerName: data.bannerName,
                                mood: data.mood.toLowerCase(),
                                url: data.imageUrl
                            };
                            columnGenerationState.links.push(link);
                            addImageToProgress(link);
                            statusDiv.innerText = `Generated: ${data.bannerName} (${data.mood})`;
                        }
                    }
                }
            } catch (err) {
                if (err.name === 'AbortError') {
                    statusDiv.innerText = '‚èπÔ∏è Generation stopped.';
                } else {
                    statusDiv.innerText = '‚ùå Network error: ' + err.message;
                }
                columnGenerationState.isGenerating = false;
                document.getElementById('columnStopBtn').style.display = 'none';
            }
        }

        function stopColumnGeneration() {
            if (columnGenerationState.abortController) {
                columnGenerationState.abortController.abort();
                columnGenerationState.abortController = null;
                columnGenerationState.isGenerating = false;
                document.getElementById('columnStopBtn').style.display = 'none';
                document.getElementById('columnStatus').innerText = 'Generation stopped by user.';
            }
        }

        async function approveGeneration() {
            const field = columnGenerationState.field;
            const bannerId = fieldToBannerId[field];
            if (!bannerId) return;

            await updateMoodFields(columnGenerationState.links, bannerId, columnGenerationState.selectedMoodNames);
            downloadLinksCsv(columnGenerationState.links);
        }

        function rejectGeneration() {
            downloadLinksCsv(columnGenerationState.links);
            const msgDiv = document.getElementById('rejectMessage');
            msgDiv.style.display = 'flex';
            setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 5000);
        }

        async function updateMoodFields(links, bannerId, selectedMoodNames) {
            const field = bannerFieldMap[bannerId];
            if (!field) {
                showMessage(`Unknown banner ID ${bannerId}`, 'error');
                return;
            }

            let linksToUpdate = links;
            if (selectedMoodNames && selectedMoodNames.length > 0) {
                linksToUpdate = links.filter(link => selectedMoodNames.includes(link.mood.toLowerCase()));
            }

            if (linksToUpdate.length === 0) {
                showMessage('No links to update for selected moods.', 'info');
                return;
            }

            let successCount = 0;
            let errorMessages = [];

            for (const link of linksToUpdate) {
                const moodId = moodNameToId[link.mood.toLowerCase()];
                if (!moodId) {
                    errorMessages.push(`Unknown mood: ${link.mood}`);
                    continue;
                }

                try {
                    const getRes = await fetch(`/api/base_moods/${moodId}`, { credentials: 'same-origin' });
                    if (!getRes.ok) {
                        errorMessages.push(`Mood ${moodId}: Failed to fetch current data (HTTP ${getRes.status})`);
                        continue;
                    }
                    const getData = await getRes.json();
                    if (!getData.success) {
                        errorMessages.push(`Mood ${moodId}: Error fetching current data: ${getData.error}`);
                        continue;
                    }
                    const mood = getData.data;

                    mood[field] = link.url;
                    delete mood.id;
                    delete mood.created_at;
                    delete mood.updated_at;

                    const putRes = await fetch(`/api/base_moods/${moodId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify(mood)
                    });

                    const responseText = await putRes.text();
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        errorMessages.push(`Mood ${moodId}: Non‚ÄëJSON response (HTTP ${putRes.status}) ‚Äì ${responseText.slice(0,100)}`);
                        continue;
                    }

                    if (putRes.ok && result.success) {
                        const idx = allMoods.findIndex(m => m.id === moodId);
                        if (idx !== -1) allMoods[idx][field] = link.url;
                        successCount++;
                    } else {
                        errorMessages.push(`Mood ${moodId}: ${result.error || 'Unknown'} (HTTP ${putRes.status})`);
                    }
                } catch (err) {
                    errorMessages.push(`Mood ${moodId}: Network error ‚Äì ${err.message}`);
                }
            }

            if (successCount > 0) {
                showMessage(`‚úÖ Updated ${successCount} moods for "${field}"`, 'success');
            }
            if (errorMessages.length > 0) {
                showMessage(`‚ùå Errors:\n${errorMessages.join('\n')}`, 'error');
            }

            filterAndDisplay();
        }

        function downloadLinksCsv(links) {
            if (!links || links.length === 0) {
                alert('No links to download.');
                return;
            }

            const headers = ['Banner ID', 'Banner Name', 'Mood', 'Image URL'];
            const rows = links.map(item => [
                item.bannerId,
                item.bannerName,
                item.mood,
                item.url
            ]);

            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                const escapedRow = row.map(cell => {
                    if (typeof cell === 'string' && (cell.includes(',') || cell.includes('"'))) {
                        return `"${cell.replace(/"/g, '""')}"`;
                    }
                    return cell;
                }).join(',');
                csvContent += escapedRow + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'generated_links.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ---------- Individual Banner AI Generation ----------
        let bannerAbortController = null;
        let bannerIsGenerating = false;

        function openBannerAIModal(fieldName) {
            const bannerId = fieldToBannerId[fieldName];
            if (!bannerId) {
                alert('Unknown field');
                return;
            }
            const defaults = bannerDefaults[bannerId] || {};
            document.getElementById('bannerField').value = fieldName;
            document.getElementById('bannerFieldName').innerText = fieldName.replace(/_/g, ' ');
            document.getElementById('bannerTitle').value = defaults.title || '';
            document.getElementById('bannerSubTitle').value = defaults.sub_title || '';
            document.getElementById('bannerDescription').value = defaults.description || '';
            document.getElementById('bannerCta').value = defaults.cta || '';
            document.getElementById('bannerBackground').value = defaults.background || 'mood based';
            document.getElementById('bannerObject').value = defaults.object || '';
            document.getElementById('bannerSize').value = 'Landscape';
            document.getElementById('bannerInspiration').value = 'Bollywood landscape field';
            
            document.getElementById('bannerProgress').innerHTML = '';
            document.getElementById('bannerStatus').innerText = '';
            document.getElementById('bannerProgressArea').style.display = 'none';
            
            document.getElementById('bannerAiModal').classList.add('show');
        }

        function closeBannerAIModal() {
            if (bannerAbortController) {
                bannerAbortController.abort();
                bannerAbortController = null;
                bannerIsGenerating = false;
            }
            document.getElementById('bannerAiModal').classList.remove('show');
        }

        async function startBannerGeneration() {
            const fieldName = document.getElementById('bannerField').value;
            const bannerId = fieldToBannerId[fieldName];
            if (!bannerId) return;

            const bannerData = {
                banner_id: bannerId,
                banner_name: fieldName.replace(/_/g, ' '),
                size: document.getElementById('bannerSize').value,
                title: document.getElementById('bannerTitle').value,
                sub_title: document.getElementById('bannerSubTitle').value,
                description: document.getElementById('bannerDescription').value,
                cta: document.getElementById('bannerCta').value,
                background: document.getElementById('bannerBackground').value,
                object: document.getElementById('bannerObject').value
            };
            const inspiration = document.getElementById('bannerInspiration').value;
            const systemPrompt = document.getElementById('bannerSystemPrompt').value.trim() || undefined;
            const userTemplate = document.getElementById('bannerUserPromptTemplate').value.trim() || undefined;

            const requestJson = {
                version: "1.0",
                total_banners: 1,
                banners: [bannerData]
            };

            document.getElementById('bannerProgress').innerHTML = '';
            document.getElementById('bannerStatus').innerText = '';
            document.getElementById('bannerProgressArea').style.display = 'block';
            document.getElementById('bannerStopBtn').style.display = 'inline-flex';

            bannerAbortController = new AbortController();
            bannerIsGenerating = true;

            const progressDiv = document.getElementById('bannerProgress');
            const statusDiv = document.getElementById('bannerStatus');
            const links = [];

            try {
                const response = await fetch('/api/ai/generate-banners', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    signal: bannerAbortController.signal,
                    body: JSON.stringify({ 
                        json: requestJson, 
                        inspiration,
                        systemPrompt,
                        userPromptTemplate: userTemplate
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    statusDiv.innerText = '‚ùå Error: ' + err.error;
                    bannerIsGenerating = false;
                    document.getElementById('bannerStopBtn').style.display = 'none';
                    return;
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            if (data.error) {
                                statusDiv.innerText = '‚ùå Error: ' + data.error;
                                bannerIsGenerating = false;
                                document.getElementById('bannerStopBtn').style.display = 'none';
                                return;
                            }
                            if (data.done) {
                                statusDiv.innerText = `‚úÖ Banner ${fieldName} completed.`;
                                document.getElementById('bannerStopBtn').style.display = 'none';
                                bannerIsGenerating = false;
                                break;
                            }
                            const container = document.createElement('div');
                            container.className = 'img-container';
                            const img = document.createElement('img');
                            img.src = data.imageUrl;
                            img.className = 'progress-img';
                            img.title = `${data.bannerName} - ${data.mood}`;
                            container.appendChild(img);
                            const downloadLink = document.createElement('a');
                            downloadLink.href = data.imageUrl;
                            downloadLink.download = `${data.bannerName}_${data.mood}.png`;
                            downloadLink.className = 'img-download';
                            downloadLink.innerHTML = '‚¨áÔ∏è';
                            downloadLink.onclick = (e) => e.stopPropagation();
                            container.appendChild(downloadLink);
                            progressDiv.appendChild(container);
                            statusDiv.innerText = `Generated: ${data.bannerName} (${data.mood})`;

                            links.push({
                                bannerId: data.bannerId,
                                bannerName: data.bannerName,
                                mood: data.mood.toLowerCase(),
                                url: data.imageUrl
                            });
                        }
                    }
                }
            } catch (err) {
                if (err.name === 'AbortError') {
                    statusDiv.innerText = '‚èπÔ∏è Generation stopped.';
                } else {
                    statusDiv.innerText = '‚ùå Network error: ' + err.message;
                }
                bannerIsGenerating = false;
                document.getElementById('bannerStopBtn').style.display = 'none';
            }
        }

        function stopBannerGeneration() {
            if (bannerAbortController) {
                bannerAbortController.abort();
                bannerAbortController = null;
                bannerIsGenerating = false;
                document.getElementById('bannerStopBtn').style.display = 'none';
            }
        }

        // ========== Row AI functions (with config, size per field, global inspiration, per-field prompts) ==========
        let rowGenerationState = {
            moodId: null,
            moodName: null,
            abortController: null,
            isGenerating: false,
            links: [],
            selectedFields: [],
            completed: false,
            fieldConfigs: {},        // key: field name, value: { title, sub_title, description, cta, background, object, size, prompt }
            globalInspiration: 'Bollywood landscape field'
        };

        function renderFieldChecklist(filter = '') {
            const container = document.getElementById('fieldChecklist');
            const searchTerm = filter.toLowerCase();
            const allFields = Object.values(bannerFieldMap);
            let html = '';
            allFields.forEach(field => {
                if (field.toLowerCase().includes(searchTerm)) {
                    const displayName = field.replace(/_/g, ' ');
                    html += `<label class="mood-pill">
                        <input type="checkbox" value="${field}">
                        ${escapeHtml(displayName)}
                    </label>`;
                }
            });
            if (!html) html = '<div class="no-results">No matching fields</div>';
            container.innerHTML = html;
        }

        function openRowAIModal(moodId) {
            const mood = allMoods.find(m => m.id === moodId);
            if (!mood) return;

            rowGenerationState = {
                moodId: moodId,
                moodName: mood.name || `Mood ${moodId}`,
                abortController: null,
                isGenerating: false,
                links: [],
                selectedFields: [],
                completed: false,
                fieldConfigs: {},
                globalInspiration: 'Bollywood landscape field'
            };

            document.getElementById('rowMoodName').innerText = rowGenerationState.moodName;
            renderFieldChecklist();

            const searchInput = document.getElementById('fieldSearch');
            searchInput.value = '';
            searchInput.oninput = (e) => renderFieldChecklist(e.target.value);

            // Hide config panel and progress area
            document.getElementById('rowConfigPanel').style.display = 'none';
            document.getElementById('rowProgressArea').style.display = 'none';
            document.getElementById('rowPostGenActions').style.display = 'none';
            document.getElementById('rowRejectMessage').style.display = 'none';
            document.getElementById('rowProgress').innerHTML = '';
            document.getElementById('rowStatus').innerText = '';

            // Set global inspiration input to default
            document.getElementById('globalInspirationInput').value = rowGenerationState.globalInspiration;

            document.getElementById('rowAiModal').classList.add('show');
        }

        function closeRowAIModal() {
            if (rowGenerationState.abortController) {
                rowGenerationState.abortController.abort();
                rowGenerationState.abortController = null;
                rowGenerationState.isGenerating = false;
            }
            document.getElementById('rowAiModal').classList.remove('show');
        }

        function showRowConfigPanel() {
            const checkboxes = document.querySelectorAll('#fieldChecklist input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one field first.');
                return;
            }

            const selectedFields = Array.from(checkboxes).map(cb => cb.value);
            rowGenerationState.selectedFields = selectedFields;

            // Build config panel HTML with prompt selection
            let html = '';
            selectedFields.forEach(field => {
                const bannerId = fieldToBannerId[field];
                const defaults = bannerDefaults[bannerId] || {};
                // Use existing config if available, otherwise defaults
                const config = rowGenerationState.fieldConfigs[field] || { 
                    ...defaults, 
                    size: 'Landscape',
                    prompt: null
                };
                // Store back to state
                rowGenerationState.fieldConfigs[field] = config;

                const promptName = config.prompt ? config.prompt.name : 'None';

                html += `<div class="config-field-group" data-field="${field}">`;
                html += `<h5>${field.replace(/_/g, ' ')}</h5>`;

                // Prompt selection row
                html += `<div class="field-row" style="grid-template-columns: 1fr 1fr 1fr;">`;
                html += `<label>Prompt</label>`;
                html += `<span id="prompt-name-${field}" style="padding: 8px; background: #f0e6f5; border-radius: 40px; text-align: center;">${escapeHtml(promptName)}</span>`;
                html += `<button class="fix-btn" onclick="selectPromptForField('${field}')" style="padding: 6px 12px;">üìã Select</button>`;
                html += `</div>`;

                // Existing fields
                html += `<div class="field-row"><label>Title</label><input type="text" id="config-${field}-title" value="${escapeHtml(config.title || '')}"></div>`;
                html += `<div class="field-row"><label>Sub Title</label><input type="text" id="config-${field}-sub_title" value="${escapeHtml(config.sub_title || '')}"></div>`;
                html += `<div class="field-row"><label>Description</label><input type="text" id="config-${field}-description" value="${escapeHtml(config.description || '')}"></div>`;
                html += `<div class="field-row"><label>CTA</label><input type="text" id="config-${field}-cta" value="${escapeHtml(config.cta || '')}"></div>`;
                html += `<div class="field-row"><label>Background</label><input type="text" id="config-${field}-background" value="${escapeHtml(config.background || 'mood based')}"></div>`;
                html += `<div class="field-row"><label>Object</label><input type="text" id="config-${field}-object" value="${escapeHtml(config.object || '')}"></div>`;
                html += `<div class="field-row"><label>Size</label>
                        <select id="config-${field}-size">
                            <option value="Landscape" ${config.size === 'Landscape' ? 'selected' : ''}>Landscape</option>
                            <option value="Portrait" ${config.size === 'Portrait' ? 'selected' : ''}>Portrait</option>
                            <option value="Square" ${config.size === 'Square' ? 'selected' : ''}>Square</option>
                        </select>
                        </div>`;
                html += `</div>`;
            });

            document.getElementById('rowConfigList').innerHTML = html;
            document.getElementById('rowConfigPanel').style.display = 'block';
        }

        function selectPromptForField(field) {
            window._currentPromptField = field;
            openPromptsModal(true);
        }

        function hideRowConfigPanel() {
            document.getElementById('rowConfigPanel').style.display = 'none';
        }

        function saveRowConfigs() {
            // Read global inspiration
            rowGenerationState.globalInspiration = document.getElementById('globalInspirationInput').value;

            // Read values from inputs and update fieldConfigs (preserve prompt)
            for (const field of rowGenerationState.selectedFields) {
                const config = {
                    title: document.getElementById(`config-${field}-title`).value,
                    sub_title: document.getElementById(`config-${field}-sub_title`).value,
                    description: document.getElementById(`config-${field}-description`).value,
                    cta: document.getElementById(`config-${field}-cta`).value,
                    background: document.getElementById(`config-${field}-background`).value,
                    object: document.getElementById(`config-${field}-object`).value,
                    size: document.getElementById(`config-${field}-size`).value,
                    prompt: rowGenerationState.fieldConfigs[field].prompt // keep existing prompt
                };
                rowGenerationState.fieldConfigs[field] = config;
            }
            showMessage('Configurations saved.', 'success');
            hideRowConfigPanel();
        }

        function addRowImageToProgress(link) {
            const progressDiv = document.getElementById('rowProgress');
            const container = document.createElement('div');
            container.className = 'img-container';
            const img = document.createElement('img');
            img.src = link.url;
            img.className = 'progress-img';
            img.title = `${link.bannerName} - ${link.mood}`;
            container.appendChild(img);
            const downloadLink = document.createElement('a');
            downloadLink.href = link.url;
            downloadLink.download = `${link.bannerName}_${link.mood}.png`;
            downloadLink.className = 'img-download';
            downloadLink.innerHTML = '‚¨áÔ∏è';
            downloadLink.onclick = (e) => e.stopPropagation();
            container.appendChild(downloadLink);
            progressDiv.appendChild(container);
        }

        async function startRowGeneration() {
            // Ensure we have selected fields
            if (rowGenerationState.selectedFields.length === 0) {
                // If they didn't click Configure, get selected from checkboxes
                const checkboxes = document.querySelectorAll('#fieldChecklist input[type="checkbox"]:checked');
                if (checkboxes.length === 0) {
                    alert('Please select at least one field.');
                    return;
                }
                rowGenerationState.selectedFields = Array.from(checkboxes).map(cb => cb.value);
            }

            // Prepare UI
            document.getElementById('rowProgress').innerHTML = '';
            document.getElementById('rowStatus').innerText = '';
            document.getElementById('rowProgressArea').style.display = 'block';
            document.getElementById('rowStopBtn').style.display = 'inline-flex';
            document.getElementById('rowPostGenActions').style.display = 'none';
            document.getElementById('rowRejectMessage').style.display = 'none';

            rowGenerationState.abortController = new AbortController();
            rowGenerationState.isGenerating = true;
            rowGenerationState.links = [];
            rowGenerationState.completed = false;

            const statusDiv = document.getElementById('rowStatus');
            const moodNameLower = rowGenerationState.moodName.toLowerCase();

            try {
                // Loop through each selected field sequentially
                for (const field of rowGenerationState.selectedFields) {
                    if (rowGenerationState.abortController.signal.aborted) {
                        statusDiv.innerText = '‚èπÔ∏è Generation aborted.';
                        break;
                    }

                    const bannerId = fieldToBannerId[field];
                    if (!bannerId) continue;

                    const config = rowGenerationState.fieldConfigs[field] || bannerDefaults[bannerId] || {};

                    const banner = {
                        banner_id: bannerId,
                        banner_name: field.replace(/_/g, ' '),
                        size: config.size || 'Landscape',
                        title: config.title || '',
                        sub_title: config.sub_title || '',
                        description: config.description || '',
                        cta: config.cta || '',
                        background: config.background || 'mood based',
                        object: config.object || ''
                    };

                    const requestJson = {
                        version: "1.0",
                        total_banners: 1,
                        banners: [banner],
                        moods: [moodNameLower]   // only this mood
                    };

                    const body = {
                        json: requestJson,
                        inspiration: rowGenerationState.globalInspiration
                    };

                    // Add prompt if configured for this field
                    if (config.prompt) {
                        body.systemPrompt = config.prompt.system;
                        body.userPromptTemplate = config.prompt.user;
                    }

                    statusDiv.innerText = `Generating for field: ${field}...`;

                    const response = await fetch('/api/ai/generate-banners', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        signal: rowGenerationState.abortController.signal,
                        body: JSON.stringify(body)
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        statusDiv.innerText = `‚ùå Error on ${field}: ` + err.error;
                        // Continue with next field? We'll stop on error for now.
                        break;
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n\n');
                        buffer = lines.pop();

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = JSON.parse(line.slice(6));
                                if (data.error) {
                                    statusDiv.innerText = `‚ùå Error on ${field}: ` + data.error;
                                    // Optionally abort further fields
                                    rowGenerationState.abortController.abort();
                                    break;
                                }
                                if (data.done) {
                                    statusDiv.innerText = `‚úÖ Completed ${field}.`;
                                    break;
                                }
                                const link = {
                                    bannerId: data.bannerId,
                                    bannerName: data.bannerName,
                                    mood: data.mood.toLowerCase(),
                                    url: data.imageUrl
                                };
                                rowGenerationState.links.push(link);
                                addRowImageToProgress(link);
                                statusDiv.innerText = `Generated: ${data.bannerName} (${data.mood})`;
                            }
                        }
                    }

                    // Small delay between fields
                    await new Promise(r => setTimeout(r, 500));
                }

                // All fields processed
                if (!rowGenerationState.abortController.signal.aborted) {
                    statusDiv.innerText = `‚úÖ All generations completed for mood "${rowGenerationState.moodName}".`;
                    document.getElementById('rowStopBtn').style.display = 'none';
                    document.getElementById('rowPostGenActions').style.display = 'flex';
                    rowGenerationState.isGenerating = false;
                    rowGenerationState.completed = true;
                }
            } catch (err) {
                if (err.name === 'AbortError') {
                    statusDiv.innerText = '‚èπÔ∏è Generation stopped.';
                } else {
                    statusDiv.innerText = '‚ùå Network error: ' + err.message;
                }
                rowGenerationState.isGenerating = false;
                document.getElementById('rowStopBtn').style.display = 'none';
            }
        }

        function stopRowGeneration() {
            if (rowGenerationState.abortController) {
                rowGenerationState.abortController.abort();
                rowGenerationState.abortController = null;
                rowGenerationState.isGenerating = false;
                document.getElementById('rowStopBtn').style.display = 'none';
                document.getElementById('rowStatus').innerText = 'Generation stopped by user.';
            }
        }

        async function approveRowGeneration() {
            const moodId = rowGenerationState.moodId;
            const links = rowGenerationState.links;

            if (!moodId || links.length === 0) {
                showMessage('No images to save.', 'info');
                return;
            }

            let successCount = 0;
            let errorMessages = [];

            for (const link of links) {
                const field = bannerFieldMap[link.bannerId];
                if (!field) {
                    errorMessages.push(`Unknown banner ID ${link.bannerId}`);
                    continue;
                }

                try {
                    const getRes = await fetch(`/api/base_moods/${moodId}`, { credentials: 'same-origin' });
                    if (!getRes.ok) {
                        errorMessages.push(`Mood ${moodId}: Failed to fetch (HTTP ${getRes.status})`);
                        continue;
                    }
                    const getData = await getRes.json();
                    if (!getData.success) {
                        errorMessages.push(`Mood ${moodId}: ${getData.error}`);
                        continue;
                    }
                    const mood = getData.data;

                    mood[field] = link.url;
                    delete mood.id;
                    delete mood.created_at;
                    delete mood.updated_at;

                    const putRes = await fetch(`/api/base_moods/${moodId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify(mood)
                    });
                    const putData = await putRes.json();
                    if (putRes.ok && putData.success) {
                        const idx = allMoods.findIndex(m => m.id === moodId);
                        if (idx !== -1) allMoods[idx][field] = link.url;
                        successCount++;
                    } else {
                        errorMessages.push(`Mood ${moodId}, field ${field}: ${putData.error || 'Unknown'}`);
                    }
                } catch (err) {
                    errorMessages.push(`Mood ${moodId}, field ${field}: ${err.message}`);
                }
            }

            if (successCount > 0) {
                showMessage(`‚úÖ Updated ${successCount} fields for mood "${rowGenerationState.moodName}"`, 'success');
                filterAndDisplay();
            }
            if (errorMessages.length > 0) {
                showMessage(`‚ùå Errors:\n${errorMessages.join('\n')}`, 'error');
            }

            downloadLinksCsv(links);
            closeRowAIModal();
        }

        function rejectRowGeneration() {
            downloadLinksCsv(rowGenerationState.links);
            const msgDiv = document.getElementById('rowRejectMessage');
            msgDiv.style.display = 'flex';
            setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 5000);
        }

        // ---------- Table rendering (with Row AI button as first column) ----------
        function displayNormalTable(moods) {
            slideshowIntervals.forEach(clearInterval);
            slideshowIntervals = [];

            if (!moods.length) {
                document.getElementById('tableContainer').innerHTML = '<div class="empty-state">No moods found</div>';
                return;
            }

            const sample = moods[0];
            let fields = Object.keys(sample).filter(key => key !== 'created_at' && key !== 'updated_at');
            fields = fields.sort((a, b) => {
                if (a === 'id') return -1;
                if (b === 'id') return 1;
                if (a === 'name') return -1;
                if (b === 'name') return 1;
                return a.localeCompare(b);
            });

            let html = '<table><thead><tr>';
            // Add an extra header for Row AI as the first column
            html += '<th>Row AI</th>';
            fields.forEach(field => {
                let headerText = field;
                if (field !== 'id' && field !== 'name') {
                    headerText += ` <button class="column-ai-btn" onclick="openColumnAIModal('${field}')" title="Generate AI images for this field">ü§ñ</button>`;
                }
                html += `<th>${headerText}</th>`;
            });
            html += '</tr></thead><tbody>';

            moods.forEach(mood => {
                html += '<tr>';
                // Row AI button as first column
                html += `<td><button class="ai-small" onclick="openRowAIModal(${mood.id})" title="Generate images for this mood across multiple fields">ü§ñ</button></td>`;
                fields.forEach(field => {
                    if (field === 'id') {
                        html += `<td onclick="openFieldEditModal(${mood.id}, 'id')">${mood.id}</td>`;
                    } else if (field === 'name') {
                        html += `<td onclick="openFieldEditModal(${mood.id}, 'name')">${escapeHtml(mood.name) || ''}</td>`;
                    } else if (field === 'hero_bg') {
                        const urls = mood.hero_bg ? mood.hero_bg.split(',').map(s => s.trim()).filter(s => s) : [];
                        const slideshowId = `slideshow-${mood.id}`;
                        html += `<td onclick="openHeroBgModal(${mood.id})" id="${slideshowId}">`;
                        if (urls.length > 0) {
                            html += `<img class="table-img slideshow-img" src="${escapeHtml(urls[0])}" data-urls="${escapeHtml(urls.join(','))}" style="max-height: ${getCurrentImageSize()}px;">`;
                        } else {
                            html += `<img class="table-img" src="https://via.placeholder.com/300x200?text=No+Image" style="max-height: ${getCurrentImageSize()}px;">`;
                        }
                        html += '</td>';
                    } else {
                        const url = mood[field] || '';
                        html += `<td onclick="openFieldEditModal(${mood.id}, '${field}')">`;
                        html += `<img class="table-img" src="${escapeHtml(url)}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'" style="max-height: ${getCurrentImageSize()}px;">`;
                        html += '</td>';
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table>';

            document.getElementById('tableContainer').innerHTML = html;

            moods.forEach(m => {
                const slideshowCell = document.getElementById(`slideshow-${m.id}`);
                if (slideshowCell) {
                    const img = slideshowCell.querySelector('.slideshow-img');
                    if (img) {
                        const urls = img.dataset.urls ? img.dataset.urls.split(',').map(s => s.trim()) : [];
                        if (urls.length > 1) {
                            let index = 0;
                            const interval = setInterval(() => {
                                index = (index + 1) % urls.length;
                                img.src = urls[index];
                            }, 2000);
                            slideshowIntervals.push(interval);
                        }
                    }
                }
            });

            updateImageSizes();
        }

        // ---------- Load and filter ----------
        async function loadMoods() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            try {
                const res = await fetch('/api/base_moods');
                const data = await res.json();
                if (data.success) {
                    allMoods = data.data;
                    filterAndDisplay();
                } else throw new Error(data.error);
            } catch (err) {
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Error: ' + err.message;
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function filterAndDisplay() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allMoods.filter(m => (m.name || '').toLowerCase().includes(search));
            displayNormalTable(filtered);
        }

        function getCurrentImageSize() {
            const slider = document.getElementById('imageSizeSlider');
            const percent = slider ? parseInt(slider.value) : 100;
            return Math.round(BASE_IMAGE_SIZE * percent / 100);
        }

        function updateImageSizes() {
            const size = getCurrentImageSize();
            document.querySelectorAll('.table-img').forEach(img => {
                img.style.maxHeight = size + 'px';
            });
            document.getElementById('sizeValue').textContent = document.getElementById('imageSizeSlider').value + '%';
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe.replace(/[&<>"]/g, function(m) {
                if(m === '&') return '&amp;';
                if(m === '<') return '&lt;';
                if(m === '>') return '&gt;';
                if(m === '"') return '&quot;';
                return m;
            });
        }

        // ---------- Single field edit modal (unchanged) ----------
        function openFieldEditModal(moodId, field) {
            const mood = allMoods.find(m => m.id === moodId);
            if (!mood) return;

            currentEditMoodId = moodId;
            currentEditField = field;

            const moodName = mood.name || `Mood ${moodId}`;
            document.getElementById('modalTitle').innerHTML = `‚úèÔ∏è Edit ${field} for "${escapeHtml(moodName)}"`;

            const value = mood[field] || '';
            const isImage = field !== 'name' && field !== 'id';

            let html = `<div class="single-field-card">`;
            html += `<div class="field-label">${field}</div>`;

            if (isImage) {
                html += `
                    <img class="image-preview" id="single-preview" src="${escapeHtml(value)}" 
                         onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'"
                         onclick="window.open(this.src, '_blank')">
                    <div class="upload-area">
                        <button class="upload-btn-small" onclick="document.getElementById('single-file-input').click()">
                            üìÅ Upload New
                        </button>
                        <input type="file" class="file-input" id="single-file-input" accept="image/*">
                        <span class="uploading-indicator" id="single-uploading">‚è≥ Uploading...</span>
                    </div>
                    <input type="text" class="text-field" id="single-field-input" 
                           value="${escapeHtml(value)}" placeholder="Image URL">
                `;
            } else {
                html += `<input type="text" class="text-field" id="single-field-input" value="${escapeHtml(value)}" placeholder="Enter value">`;
            }

            html += '</div>';
            document.getElementById('modalBody').innerHTML = html;

            if (isImage) {
                const fileInput = document.getElementById('single-file-input');
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const indicator = document.getElementById('single-uploading');
                    indicator.style.display = 'inline-flex';
                    const formData = new FormData();
                    formData.append('image', file);
                    try {
                        const res = await fetch('https://api.zulushop.in/api/v1/user/upload', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await res.json();
                        const url = data.url || data.image_url;
                        if (url) {
                            document.getElementById('single-preview').src = url;
                            document.getElementById('single-field-input').value = url;
                            showMessage('‚úÖ Image uploaded', 'success');
                        } else {
                            showMessage('‚ùå Upload failed: no URL', 'error');
                        }
                    } catch (err) {
                        showMessage('‚ùå Upload error: ' + err.message, 'error');
                    } finally {
                        indicator.style.display = 'none';
                        fileInput.value = '';
                    }
                });
            }

            document.getElementById('editModal').classList.add('show');
        }

        function openHeroBgModal(moodId) {
            const mood = allMoods.find(m => m.id === moodId);
            if (!mood) return;

            currentEditMoodId = moodId;
            currentEditField = 'hero_bg';

            const urls = mood.hero_bg ? mood.hero_bg.split(',').map(s => s.trim()).filter(s => s) : [];
            currentHeroUrls = [...urls];
            currentHeroIndex = 0;

            const moodName = mood.name || `Mood ${moodId}`;
            document.getElementById('modalTitle').innerHTML = `‚úèÔ∏è Edit hero_bg for "${escapeHtml(moodName)}"`;

            renderHeroBgModal();

            document.getElementById('editModal').classList.add('show');
        }

        function renderHeroBgModal() {
            let html = `<div class="hero-bg-editor">`;

            html += `<div class="carousel-container">`;
            if (currentHeroUrls.length > 0) {
                html += `<img class="carousel-image" src="${escapeHtml(currentHeroUrls[currentHeroIndex])}" id="carousel-img">`;
                html += `<button class="carousel-prev" onclick="carouselPrev()">‚ùÆ</button>`;
                html += `<button class="carousel-next" onclick="carouselNext()">‚ùØ</button>`;
                html += `<button class="carousel-remove" onclick="removeCurrentImage()">‚úñ</button>`;
            } else {
                html += `<p>No images</p>`;
            }
            html += `</div>`;

            html += `<div class="image-list">`;
            currentHeroUrls.forEach((url, index) => {
                const selectedClass = index === currentHeroIndex ? 'selected' : '';
                html += `<div class="image-list-item ${selectedClass}" data-index="${index}" onclick="carouselGoTo(${index})">`;
                html += `<img src="${escapeHtml(url)}">`;
                html += `<button onclick="removeImage(${index}); event.stopPropagation();">‚úñ</button>`;
                html += `</div>`;
            });
            html += `</div>`;

            html += `<div class="add-image">`;
            html += `<input type="text" id="new-image-url" placeholder="Image URL">`;
            html += `<button onclick="addImage()">Add URL</button>`;
            html += `<button class="upload-btn-small" onclick="document.getElementById('hero-file-input').click()">üìÅ Upload</button>`;
            html += `<input type="file" id="hero-file-input" accept="image/*" style="display:none">`;
            html += `<span class="uploading-indicator" id="hero-uploading">‚è≥ Uploading...</span>`;
            html += `</div>`;

            html += `</div>`;
            document.getElementById('modalBody').innerHTML = html;

            const fileInput = document.getElementById('hero-file-input');
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const indicator = document.getElementById('hero-uploading');
                indicator.style.display = 'inline-flex';
                const formData = new FormData();
                formData.append('image', file);
                try {
                    const res = await fetch('https://api.zulushop.in/api/v1/user/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    const url = data.url || data.image_url;
                    if (url) {
                        currentHeroUrls.push(url);
                        if (currentHeroUrls.length === 1) currentHeroIndex = 0;
                        renderHeroBgModal();
                        showMessage('‚úÖ Image uploaded', 'success');
                    } else {
                        showMessage('‚ùå Upload failed: no URL', 'error');
                    }
                } catch (err) {
                    showMessage('‚ùå Upload error: ' + err.message, 'error');
                } finally {
                    indicator.style.display = 'none';
                    fileInput.value = '';
                }
            });
        }

        window.carouselPrev = function() {
            if (currentHeroUrls.length > 0) {
                currentHeroIndex = (currentHeroIndex - 1 + currentHeroUrls.length) % currentHeroUrls.length;
                renderHeroBgModal();
            }
        };

        window.carouselNext = function() {
            if (currentHeroUrls.length > 0) {
                currentHeroIndex = (currentHeroIndex + 1) % currentHeroUrls.length;
                renderHeroBgModal();
            }
        };

        window.carouselGoTo = function(index) {
            if (index >= 0 && index < currentHeroUrls.length) {
                currentHeroIndex = index;
                renderHeroBgModal();
            }
        };

        window.removeCurrentImage = function() {
            if (currentHeroUrls.length > 0) {
                currentHeroUrls.splice(currentHeroIndex, 1);
                if (currentHeroIndex >= currentHeroUrls.length) {
                    currentHeroIndex = Math.max(0, currentHeroUrls.length - 1);
                }
                renderHeroBgModal();
            }
        };

        window.removeImage = function(index) {
            if (index >= 0 && index < currentHeroUrls.length) {
                currentHeroUrls.splice(index, 1);
                if (currentHeroIndex >= currentHeroUrls.length) {
                    currentHeroIndex = Math.max(0, currentHeroUrls.length - 1);
                } else if (index < currentHeroIndex) {
                    currentHeroIndex--;
                }
                renderHeroBgModal();
            }
        };

        window.addImage = function() {
            const input = document.getElementById('new-image-url');
            const url = input.value.trim();
            if (url) {
                currentHeroUrls.push(url);
                if (currentHeroUrls.length === 1) currentHeroIndex = 0;
                input.value = '';
                renderHeroBgModal();
            }
        };

        async function saveSingleField() {
            if (!currentEditMoodId || !currentEditField) return;

            if (currentEditField === 'hero_bg') {
                await saveHeroBg();
                return;
            }

            const input = document.getElementById('single-field-input');
            if (!input) return;

            const newValue = input.value;
            const updateData = {};
            updateData[currentEditField] = newValue;

            try {
                const res = await fetch(`/api/base_moods/${currentEditMoodId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                const result = await res.json();
                if (result.success) {
                    const idx = allMoods.findIndex(m => m.id === currentEditMoodId);
                    if (idx !== -1) {
                        allMoods[idx][currentEditField] = newValue;
                    }
                    filterAndDisplay();
                    closeEditModal();
                    showMessage('‚úÖ Field updated successfully', 'success');
                } else {
                    showMessage('‚ùå Error: ' + result.error, 'error');
                }
            } catch (err) {
                showMessage('‚ùå Save failed: ' + err.message, 'error');
            }
        }

        async function saveHeroBg() {
            if (!currentEditMoodId) return;
            const newValue = currentHeroUrls.join(', ');
            const updateData = { hero_bg: newValue };
            try {
                const res = await fetch(`/api/base_moods/${currentEditMoodId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                const result = await res.json();
                if (result.success) {
                    const idx = allMoods.findIndex(m => m.id === currentEditMoodId);
                    if (idx !== -1) {
                        allMoods[idx].hero_bg = newValue;
                    }
                    filterAndDisplay();
                    closeEditModal();
                    showMessage('‚úÖ Hero BG updated successfully', 'success');
                } else {
                    showMessage('‚ùå Error: ' + result.error, 'error');
                }
            } catch (err) {
                showMessage('‚ùå Save failed: ' + err.message, 'error');
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            currentEditMoodId = null;
            currentEditField = null;
            currentHeroUrls = [];
            currentHeroIndex = 0;
        }

        // ---------- Event listeners ----------
        document.getElementById('searchInput').addEventListener('input', filterAndDisplay);
        document.getElementById('imageSizeSlider').addEventListener('input', function(e) {
            document.getElementById('sizeValue').textContent = e.target.value + '%';
            updateImageSizes();
        });

        window.addEventListener('click', (event) => {
            const editModal = document.getElementById('editModal');
            if (event.target === editModal) closeEditModal();
            const bannerAiModal = document.getElementById('bannerAiModal');
            if (event.target === bannerAiModal) closeBannerAIModal();
            const columnAiModal = document.getElementById('columnAiModal');
            if (event.target === columnAiModal) closeColumnAIModal();
            const rowAiModal = document.getElementById('rowAiModal');
            if (event.target === rowAiModal) closeRowAIModal();
            const promptsModal = document.getElementById('promptsModal');
            if (event.target === promptsModal) closePromptsModal();
        });

        // Initial load
        loadMoods();
    </script>
</body>
</html>